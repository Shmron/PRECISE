<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environmental & Social Determinants of Maternal Health | PRECISE Network</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;800&family=Source+Sans+3:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --copper: #B87333;
            --copper-light: #D4956A;
            --teal-deep: #1A535C;
            --teal-mid: #4ECDC4;
            --sage: #6B8E6B;
            --slate: #3D5A73;
            --coral: #E07A5F;
            --sand: #F4E9D8;
            --charcoal: #2D3436;
            --cream: #FFFBF5;
            --ivory: #FDFCFA;
            --mist: #E8EEF2;
            --gold: #D4AF37;
            --burgundy: #722F37;
            --forest: #2D5016;
            --lavender: #7B6BA8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans 3', sans-serif; background: var(--cream); color: var(--charcoal); line-height: 1.7; font-weight: 400; }
        body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E"); opacity: 0.015; pointer-events: none; z-index: 0; }
        .container { max-width: 1500px; margin: 0 auto; background: var(--ivory); position: relative; z-index: 1; box-shadow: 0 0 80px rgba(45, 52, 54, 0.08); }
        .container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, var(--copper) 0%, var(--copper) 20%, var(--teal-deep) 20%, var(--teal-deep) 40%, var(--coral) 40%, var(--coral) 60%, var(--sage) 60%, var(--sage) 80%, var(--lavender) 80%, var(--lavender) 100%); }
        header { padding: 5rem 4rem 4rem; background: linear-gradient(180deg, var(--ivory) 0%, var(--sand) 100%); position: relative; overflow: hidden; }
        header::after { content: ''; position: absolute; top: -100px; right: -100px; width: 400px; height: 400px; border: 2px solid var(--copper); border-radius: 50%; opacity: 0.08; }
        .header-label { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; letter-spacing: 0.25em; text-transform: uppercase; color: var(--copper); font-weight: 600; margin-bottom: 2rem; display: inline-flex; align-items: center; gap: 1rem; }
        .header-label::before { content: ''; display: inline-block; width: 40px; height: 2px; background: var(--copper); }
        header h1 { font-family: 'Playfair Display', serif; font-size: 3.8rem; font-weight: 700; color: var(--charcoal); line-height: 1.1; margin-bottom: 1.5rem; max-width: 900px; letter-spacing: -0.02em; }
        header h1 span { color: var(--copper); }
        .header-subtitle { font-size: 1.2rem; font-weight: 300; color: var(--slate); max-width: 650px; line-height: 1.8; }
        .header-meta { display: flex; gap: 3rem; flex-wrap: wrap; margin-top: 3rem; padding-top: 2.5rem; border-top: 1px solid rgba(184, 115, 51, 0.2); }
        .meta-item { display: flex; flex-direction: column; gap: 0.4rem; }
        .meta-label { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--slate); }
        .meta-value { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 600; color: var(--charcoal); }
        .header-actions { display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap; }
        .header-btn { display: inline-flex; align-items: center; gap: 0.6rem; padding: 0.9rem 1.6rem; border-radius: 4px; font-family: 'Source Sans 3', sans-serif; font-size: 0.95rem; font-weight: 600; text-decoration: none; cursor: pointer; transition: all 0.3s ease; border: none; }
        .header-btn-primary { background: var(--teal-deep); color: white; }
        .header-btn-primary:hover { background: var(--copper); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(184, 115, 51, 0.3); }
        .header-btn-secondary { background: white; color: var(--teal-deep); border: 2px solid var(--teal-deep); }
        .header-btn-secondary:hover { background: var(--teal-deep); color: white; transform: translateY(-2px); }
        .header-btn svg { width: 18px; height: 18px; fill: currentColor; }
        .btn-note { font-size: 0.75rem; font-weight: 400; opacity: 0.8; margin-left: 0.3rem; }
        .regional-breakdown { margin-top: 2.5rem; padding-top: 2rem; border-top: 1px solid rgba(184, 115, 51, 0.15); }
        .regional-title { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--slate); margin-bottom: 1.2rem; }
        .region-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
        .region-card { background: white; border-radius: 8px; padding: 1.5rem; border-left: 4px solid; box-shadow: 0 2px 12px rgba(45, 52, 54, 0.06); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .region-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(45, 52, 54, 0.1); }
        .region-card.kenya { border-color: var(--teal-deep); }
        .region-card.mozambique { border-color: var(--coral); }
        .region-card.gambia { border-color: var(--copper); }
        .region-name { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 700; color: var(--charcoal); margin-bottom: 0.8rem; display: flex; align-items: center; gap: 0.5rem; }
        .region-flag { font-size: 1.2rem; }
        .region-stats { display: flex; flex-direction: column; gap: 0.5rem; }
        .region-stat { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .region-stat-label { color: var(--slate); }
        .region-stat-value { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--charcoal); }
        .region-bar { height: 6px; background: var(--mist); border-radius: 3px; margin-top: 0.8rem; overflow: hidden; }
        .region-bar-fill { height: 100%; border-radius: 3px; transition: width 0.8s ease; }
        .region-card.kenya .region-bar-fill { background: var(--teal-deep); width: 47.8%; }
        .region-card.mozambique .region-bar-fill { background: var(--coral); width: 30.7%; }
        .region-card.gambia .region-bar-fill { background: var(--copper); width: 19.1%; }
        @media (max-width: 900px) { .region-cards { grid-template-columns: 1fr; } }

        /* Query Builder Modal */
        .explorer-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(45,52,54,0.85); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 1.5rem; }
        .explorer-overlay.active { display: flex; }
        .explorer-modal { background: var(--ivory); border-radius: 12px; max-width: 1000px; width: 100%; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 80px rgba(0,0,0,0.4); display: flex; flex-direction: column; }
        .explorer-header { padding: 1.25rem 2rem; background: linear-gradient(135deg, var(--teal-deep) 0%, #2a6b75 100%); color: white; display: flex; justify-content: space-between; align-items: center; }
        .explorer-header h2 { font-family: 'Playfair Display', serif; font-size: 1.4rem; margin: 0; }
        .explorer-close { background: none; border: none; color: white; font-size: 1.8rem; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; }
        .explorer-close:hover { opacity: 1; }
        .explorer-body { padding: 1.5rem 2rem; overflow-y: auto; flex: 1; }
        .explorer-loading { text-align: center; padding: 3rem; color: var(--slate); }

        /* Query Builder Sections */
        .qb-section { margin-bottom: 1.5rem; }
        .qb-section-title { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--slate); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .qb-section-title::after { content: ''; flex: 1; height: 1px; background: var(--mist); }

        /* Base Filters Row */
        .qb-base-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; padding: 1rem; background: var(--sand); border-radius: 8px; }
        .qb-filter { display: flex; flex-direction: column; gap: 0.4rem; }
        .qb-filter label { font-size: 0.75rem; font-weight: 600; color: var(--charcoal); }
        .qb-filter select { padding: 0.6rem 0.8rem; border: 1px solid var(--mist); border-radius: 5px; font-size: 0.9rem; background: white; cursor: pointer; }
        .qb-filter select:focus { outline: none; border-color: var(--teal-deep); box-shadow: 0 0 0 2px rgba(26,83,92,0.1); }

        /* Add Filter Row */
        .qb-add-filter { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: flex-end; padding: 1rem; background: white; border: 2px dashed var(--mist); border-radius: 8px; }
        .qb-add-filter select, .qb-add-filter input { padding: 0.6rem 0.8rem; border: 1px solid var(--mist); border-radius: 5px; font-size: 0.9rem; }
        .qb-add-filter select { min-width: 180px; }
        .qb-add-filter input[type="number"] { width: 100px; }
        /* Natural Language Query */
        .qb-nl-query { display: flex; gap: 0.75rem; align-items: center; }
        .qb-btn-ai { padding: 0.7rem 1.2rem !important; transition: opacity 0.2s; }
        .qb-btn-ai:disabled { cursor: wait; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .qb-add-btn { background: var(--teal-deep); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; }
        .qb-add-btn:hover { background: var(--copper); transform: translateY(-1px); }

        /* Active Filters */
        .qb-active-filters { display: flex; flex-wrap: wrap; gap: 0.5rem; min-height: 44px; padding: 0.75rem 1rem; background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%); border-radius: 6px; border: 1px solid var(--mist); align-items: center; }
        .qb-filter-tag { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.6rem 0.4rem 0.9rem; background: var(--teal-deep); color: white; border-radius: 20px; font-size: 0.85rem; font-family: 'JetBrains Mono', monospace; }
        .qb-filter-tag .remove { background: rgba(255,255,255,0.2); border: none; color: white; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 0.9rem; line-height: 1; display: flex; align-items: center; justify-content: center; }
        .qb-filter-tag .remove:hover { background: rgba(255,255,255,0.4); }

        /* Action Buttons */
        .qb-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem; }
        .qb-btn { padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; font-size: 0.95rem; }
        .qb-btn-primary { background: var(--teal-deep); color: white; }
        .qb-btn-primary:hover { background: #2a6b75; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(26,83,92,0.3); }
        .qb-btn-secondary { background: white; color: var(--charcoal); border: 1px solid var(--mist); }
        .qb-btn-secondary:hover { background: var(--sand); }
        .qb-btn-export { background: var(--copper); color: white; }
        .qb-btn-export:hover { background: #a66429; }

        /* Results */
        .qb-results { background: white; border: 1px solid var(--mist); border-radius: 8px; padding: 1.5rem; margin-top: 1rem; display: none; }
        .qb-results.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .qb-results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--mist); }
        .qb-results-count { font-size: 1.1rem; }
        .qb-results-count strong { color: var(--teal-deep); font-size: 1.5rem; font-family: 'JetBrains Mono', monospace; }
        .qb-results-percent { background: var(--teal-deep); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600; }
        .qb-results-breakdown { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .qb-country-card { padding: 1rem; background: linear-gradient(135deg, var(--sand) 0%, #f5ebe0 100%); border-radius: 8px; text-align: center; border-left: 4px solid var(--teal-deep); }
        .qb-country-card.kenya { border-left-color: var(--sage); }
        .qb-country-card.mozambique { border-left-color: var(--coral); }
        .qb-country-card.gambia { border-left-color: var(--copper); }
        .qb-country-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.3rem; }
        .qb-country-value { font-family: 'JetBrains Mono', monospace; font-size: 1.4rem; color: var(--teal-deep); }
        .qb-country-pct { font-size: 0.8rem; color: var(--slate); }

        /* Stats Grid */
        .qb-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; padding-top: 1rem; border-top: 1px solid var(--mist); }
        .qb-stat { text-align: center; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; }
        .qb-stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--slate); margin-bottom: 0.3rem; }
        .qb-stat-value { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; color: var(--charcoal); }

        @media (max-width: 600px) {
            .qb-results-breakdown { grid-template-columns: 1fr; }
            .qb-add-filter { flex-direction: column; align-items: stretch; }
            .qb-add-filter select, .qb-add-filter input { width: 100%; }
        }

        /* Variables at a Glance Infographic */
        .infographic-section { padding: 3rem 4rem; background: var(--sand); border-top: 1px solid rgba(184, 115, 51, 0.15); }
        .infographic-title { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--slate); margin-bottom: 1.5rem; text-align: center; }
        .infographic-container { display: flex; justify-content: center; }
        .infographic-img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 20px rgba(45, 52, 54, 0.1); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .infographic-img:hover { transform: scale(1.01); box-shadow: 0 8px 30px rgba(45, 52, 54, 0.15); }
        .infographic-caption { text-align: center; margin-top: 1rem; font-size: 0.9rem; color: var(--slate); }

        /* Lightbox for enlarged view */
        .lightbox { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.97); z-index: 10001; display: none; align-items: center; justify-content: center; overflow: hidden; }
        .lightbox.active { display: flex; }
        .lightbox-content { position: relative; width: 100%; height: 100%; overflow: auto; display: flex; align-items: flex-start; justify-content: center; padding: 60px 20px 80px; }
        .lightbox-content img { max-width: none; width: 95vw; height: auto; transform-origin: top left; cursor: zoom-in; transition: transform 0.3s ease; }
        .lightbox-content img.zoomed { transform: scale(1.5); cursor: zoom-out; }
        .lightbox-close { position: fixed; top: 15px; right: 25px; color: white; font-size: 36px; font-weight: bold; cursor: pointer; z-index: 10002; background: rgba(184, 115, 51, 0.9); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; }
        .lightbox-close:hover { background: var(--terracotta); transform: scale(1.1); }
        .lightbox-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 10002; }
        .lightbox-btn { background: rgba(184, 115, 51, 0.9); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .lightbox-btn:hover { background: var(--terracotta); }
        .lightbox-hint { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.9); font-size: 14px; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 25px; z-index: 10002; }

        /* Methodology image replacement */
        .methodology-img { width: 100%; max-width: 400px; border-radius: 6px; box-shadow: 0 2px 12px rgba(45, 52, 54, 0.1); }

        main { padding: 4rem; }
        .category-section { margin-bottom: 4rem; opacity: 0; transform: translateY(30px); animation: fadeSlideIn 0.7s ease forwards; }
        @keyframes fadeSlideIn { to { opacity: 1; transform: translateY(0); } }
        .category-section:nth-child(1) { animation-delay: 0.1s; }
        .category-section:nth-child(2) { animation-delay: 0.15s; }
        .category-section:nth-child(3) { animation-delay: 0.2s; }
        .category-section:nth-child(4) { animation-delay: 0.25s; }
        .category-section:nth-child(5) { animation-delay: 0.3s; }
        .category-section:nth-child(6) { animation-delay: 0.35s; }
        .category-section:nth-child(7) { animation-delay: 0.4s; }
        .category-section:nth-child(8) { animation-delay: 0.45s; }
        .category-header { display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem; cursor: pointer; padding: 1.75rem 2rem; background: var(--sand); border-left: 5px solid; transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .category-header:hover { background: var(--ivory); box-shadow: 0 8px 30px rgba(45, 52, 54, 0.06); transform: translateX(8px); }
        .category-number { font-family: 'Playfair Display', serif; font-size: 3.5rem; font-weight: 800; line-height: 1; opacity: 0.15; min-width: 90px; }
        .category-title-wrapper { flex: 1; }
        .category-icon { font-size: 1.3rem; margin-bottom: 0.25rem; opacity: 0.8; }
        .category-title { font-family: 'Playfair Display', serif; font-size: 1.9rem; font-weight: 700; color: var(--charcoal); margin: 0; letter-spacing: -0.01em; }
        .category-count { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--slate); margin-top: 0.35rem; letter-spacing: 0.08em; text-transform: uppercase; }
        .toggle-indicator { font-size: 1.2rem; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); color: var(--slate); opacity: 0.5; }
        .category-header.active .toggle-indicator { transform: rotate(180deg); }
        .cat-air { border-color: var(--teal-deep); }
        .cat-air .category-number { color: var(--teal-deep); }
        .cat-anc { border-color: var(--coral); }
        .cat-anc .category-number { color: var(--coral); }
        .cat-temp { border-color: var(--copper); }
        .cat-temp .category-number { color: var(--copper); }
        .cat-precip { border-color: var(--slate); }
        .cat-precip .category-number { color: var(--slate); }
        .cat-humid { border-color: var(--sage); }
        .cat-humid .category-number { color: var(--sage); }
        .cat-soil { border-color: var(--forest); }
        .cat-soil .category-number { color: var(--forest); }
        .cat-social { border-color: var(--burgundy); }
        .cat-social .category-number { color: var(--burgundy); }
        .cat-urban { border-color: var(--lavender); }
        .cat-urban .category-number { color: var(--lavender); }
        .variables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); gap: 1.5rem; max-height: 0; overflow: hidden; transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease; opacity: 0; }
        .variables-grid.active { max-height: 25000px; opacity: 1; margin-bottom: 2rem; }
        .variable-card { background: white; border: 1px solid rgba(45, 52, 54, 0.08); padding: 2rem; cursor: pointer; transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .variable-card::before { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 100%; background: currentColor; opacity: 0.08; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .variable-card:hover { border-color: rgba(45, 52, 54, 0.15); box-shadow: 0 12px 40px rgba(45, 52, 54, 0.08); transform: translateY(-3px); }
        .variable-card:hover::before { width: 4px; }
        .cat-air .variable-card { color: var(--teal-deep); }
        .cat-anc .variable-card { color: var(--coral); }
        .cat-temp .variable-card { color: var(--copper); }
        .cat-precip .variable-card { color: var(--slate); }
        .cat-humid .variable-card { color: var(--sage); }
        .cat-soil .variable-card { color: var(--forest); }
        .cat-social .variable-card { color: var(--burgundy); }
        .cat-urban .variable-card { color: var(--lavender); }
        .variable-name { font-family: 'Playfair Display', serif; font-size: 1.35rem; font-weight: 600; color: var(--charcoal); margin-bottom: 0.4rem; line-height: 1.3; }
        .variable-unit { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--slate); letter-spacing: 0.03em; margin-bottom: 1.25rem; }
        .stats-display { background: var(--mist); padding: 1.25rem; margin-bottom: 1.25rem; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; line-height: 2; color: var(--charcoal); }
        .stats-display div { display: flex; justify-content: space-between; align-items: center; padding: 0.15rem 0; border-bottom: 1px solid rgba(45, 52, 54, 0.05); }
        .stats-display div:last-child { border-bottom: none; }
        .stats-label { color: var(--slate); font-weight: 400; }
        .stats-value { font-weight: 600; color: var(--charcoal); }
        .expand-btn { display: inline-flex; align-items: center; gap: 0.6rem; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: currentColor; text-transform: uppercase; letter-spacing: 0.12em; border: none; background: none; cursor: pointer; padding: 0.6rem 0; transition: all 0.3s ease; font-weight: 500; }
        .expand-btn:hover { opacity: 0.7; transform: translateX(4px); }
        .expand-btn::after { content: '\2193'; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .variable-card.expanded .expand-btn::after { transform: rotate(180deg); }
        .variable-details { max-height: 0; overflow: hidden; transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1); margin-top: 1.5rem; }
        .variable-card.expanded .variable-details { max-height: 3000px; }
        .detail-section { margin-bottom: 1.75rem; padding-bottom: 1.75rem; border-bottom: 1px solid rgba(45, 52, 54, 0.08); }
        .detail-section:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
        .detail-section h4 { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.18em; color: currentColor; margin-bottom: 0.75rem; font-weight: 600; }
        .detail-section p { font-size: 0.95rem; line-height: 1.8; color: var(--slate); }
        .dataset-info { background: var(--sand); padding: 0.85rem 1.15rem; border-left: 3px solid currentColor; font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; color: var(--charcoal); margin-top: 0.5rem; }
        .formula-display { background: var(--charcoal); color: var(--sand); padding: 1.25rem 1.5rem; font-family: 'JetBrains Mono', monospace; font-size: 0.82rem; line-height: 1.9; margin-top: 0.75rem; white-space: pre-wrap; overflow-x: auto; }
        .methodology-sidebar { background: var(--sand); border: 1px solid rgba(184, 115, 51, 0.2); padding: 2.5rem; margin-bottom: 3rem; }
        .methodology-sidebar h3 { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 700; color: var(--charcoal); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem; }
        .methodology-sidebar h3::before { content: ''; display: inline-block; width: 4px; height: 24px; background: var(--teal-deep); }
        .methodology-intro { font-size: 0.95rem; color: var(--slate); margin-bottom: 2rem; line-height: 1.7; }
        .methodology-grid { display: grid; grid-template-columns: 1fr 1.3fr; gap: 2.5rem; align-items: start; }
        .hex-visual { background: white; border: 1px solid rgba(45, 52, 54, 0.1); padding: 1.5rem; }
        .hex-visual svg { width: 100%; height: auto; max-height: 280px; }
        .hex-visual-caption { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--slate); text-align: center; margin-top: 1rem; letter-spacing: 0.05em; }
        .methodology-right { display: flex; flex-direction: column; gap: 1.5rem; }
        .calc-table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; background: white; }
        .calc-table th { background: var(--teal-deep); color: white; padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; font-size: 0.65rem; }
        .calc-table td { padding: 0.6rem 0.5rem; text-align: center; border-bottom: 1px solid rgba(45, 52, 54, 0.08); }
        .calc-table tr:last-child td { background: var(--gold); font-weight: 700; color: var(--charcoal); }
        .calc-table .hex-label { font-weight: 600; color: var(--teal-deep); }
        .formula-compact { background: var(--charcoal); color: var(--teal-mid); padding: 1rem 1.25rem; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; text-align: center; letter-spacing: 0.02em; }
        .comparison-compact { display: flex; gap: 1rem; }
        .comp-item { flex: 1; background: white; border: 1px solid rgba(45, 52, 54, 0.1); padding: 1rem; text-align: center; }
        .comp-item.weighted { border-color: var(--teal-mid); background: rgba(78, 205, 196, 0.05); }
        .comp-item.centroid { border-color: var(--coral); background: rgba(224, 122, 95, 0.05); }
        .comp-label { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--slate); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; }
        .comp-value { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 700; color: var(--charcoal); }
        .comp-item.weighted .comp-value { color: var(--teal-deep); }
        .comp-item.centroid .comp-value { color: var(--coral); }
        .comp-unit { font-size: 0.9rem; font-weight: 400; }
        .comp-note { font-size: 0.7rem; color: var(--slate); margin-top: 0.3rem; }
        .tier-label { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.08em; padding: 0.25rem 0.5rem; border-radius: 3px; display: inline-block; margin-bottom: 0.5rem; }
        .tier-1 { background: #e74c3c; color: white; }
        .tier-2 { background: #f39c12; color: white; }
        .tier-3 { background: #3498db; color: white; }
        /* Abstract Section Styles */
        .abstract-section { padding: 3rem 4rem; background: linear-gradient(135deg, var(--ivory) 0%, var(--sand) 100%); border-bottom: 1px solid rgba(184, 115, 51, 0.2); }
        .abstract-section h2 { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700; color: var(--charcoal); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .abstract-section h2::before { content: ''; display: inline-block; width: 4px; height: 28px; background: var(--copper); }
        .abstract-content { display: grid; grid-template-columns: 1fr 1fr; gap: 2.5rem; }
        .abstract-column h3 { font-family: 'Playfair Display', serif; font-size: 1.25rem; font-weight: 600; color: var(--teal-deep); margin-bottom: 1rem; }
        .abstract-column p { font-size: 0.95rem; line-height: 1.85; color: var(--slate); margin-bottom: 1rem; text-align: justify; }
        .abstract-highlight { background: white; border-left: 4px solid var(--copper); padding: 1.25rem 1.5rem; margin: 1.5rem 0; }
        .abstract-highlight p { margin-bottom: 0; font-style: italic; color: var(--charcoal); }
        @media (max-width: 900px) { .abstract-content { grid-template-columns: 1fr; } .abstract-section { padding: 2rem; } }
        .references-section { margin-top: 5rem; padding: 4rem; background: var(--sand); border-top: 1px solid rgba(184, 115, 51, 0.2); }
        .references-section h2 { font-family: 'Playfair Display', serif; font-size: 2.5rem; font-weight: 700; color: var(--charcoal); margin-bottom: 2.5rem; }
        .reference-item { font-size: 0.88rem; line-height: 1.8; color: var(--slate); margin-bottom: 1rem; padding-left: 2.5rem; position: relative; }
        .reference-number { position: absolute; left: 0; font-weight: 600; color: var(--copper); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; }
        footer { padding: 4rem; background: var(--charcoal); color: var(--sand); }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 3rem; }
        .footer-section h3 { font-family: 'Playfair Display', serif; font-size: 1.15rem; margin-bottom: 1rem; color: var(--copper-light); }
        .footer-section p { font-size: 0.9rem; line-height: 1.7; opacity: 0.8; }
        @media (max-width: 900px) {
            header { padding: 3rem 2rem; }
            header h1 { font-size: 2.4rem; }
            main { padding: 2rem; }
            .methodology-grid { grid-template-columns: 1fr; }
            .category-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .category-number { font-size: 2.5rem; min-width: auto; }
            .variables-grid { grid-template-columns: 1fr; }
            .references-section, footer { padding: 3rem 2rem; }
            .comparison-compact { flex-direction: column; }
        }

        /* AI Chat Widget Styles */
        .chat-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
            font-family: 'Source Sans 3', sans-serif;
        }
        .chat-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--teal-deep) 0%, var(--copper) 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(26, 83, 92, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .chat-toggle:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 28px rgba(26, 83, 92, 0.5);
        }
        .chat-toggle svg {
            width: 28px;
            height: 28px;
            fill: white;
        }
        .chat-toggle .close-icon { display: none; }
        .chat-widget.open .chat-toggle .chat-icon { display: none; }
        .chat-widget.open .chat-toggle .close-icon { display: block; }

        .chat-panel {
            position: absolute;
            bottom: 76px;
            right: 0;
            width: 400px;
            max-width: calc(100vw - 48px);
            height: 550px;
            max-height: calc(100vh - 150px);
            background: var(--ivory);
            border-radius: 16px;
            box-shadow: 0 10px 50px rgba(45, 52, 54, 0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(184, 115, 51, 0.15);
        }
        .chat-widget.open .chat-panel { display: flex; }

        .chat-header {
            background: linear-gradient(135deg, var(--teal-deep) 0%, var(--slate) 100%);
            color: white;
            padding: 18px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chat-header-icon {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .chat-header-text h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }
        .chat-header-text p {
            font-size: 0.75rem;
            opacity: 0.85;
            margin: 2px 0 0 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--cream);
        }
        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.9rem;
            line-height: 1.6;
            animation: messageSlide 0.3s ease;
        }
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.user {
            align-self: flex-end;
            background: var(--teal-deep);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-message.assistant {
            align-self: flex-start;
            background: white;
            color: var(--charcoal);
            border: 1px solid rgba(45, 52, 54, 0.08);
            border-bottom-left-radius: 4px;
        }
        .chat-message.assistant a {
            color: var(--teal-deep);
            text-decoration: underline;
        }
        .chat-message.system {
            align-self: center;
            background: var(--sand);
            color: var(--slate);
            font-size: 0.8rem;
            padding: 8px 14px;
            border-radius: 20px;
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            width: fit-content;
            border: 1px solid rgba(45, 52, 54, 0.08);
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--slate);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-6px); opacity: 1; }
        }

        .chat-input-area {
            padding: 16px;
            background: var(--ivory);
            border-top: 1px solid rgba(45, 52, 54, 0.08);
        }
        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .chat-input {
            flex: 1;
            border: 1px solid rgba(45, 52, 54, 0.15);
            border-radius: 24px;
            padding: 12px 18px;
            font-size: 0.9rem;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            outline: none;
            transition: border-color 0.2s ease;
            background: white;
        }
        .chat-input:focus {
            border-color: var(--teal-deep);
        }
        .chat-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--teal-deep);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .chat-send:hover:not(:disabled) {
            background: var(--copper);
            transform: scale(1.05);
        }
        .chat-send:disabled {
            background: var(--mist);
            cursor: not-allowed;
        }
        .chat-send svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .suggested-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 16px;
            background: var(--sand);
            border-bottom: 1px solid rgba(45, 52, 54, 0.08);
        }
        .suggested-q {
            background: white;
            border: 1px solid rgba(45, 52, 54, 0.1);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--slate);
        }
        .suggested-q:hover {
            background: var(--teal-deep);
            color: white;
            border-color: var(--teal-deep);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-label">PRECISE Network Research</div>
            <h1>Environmental & Social Determinants of <span>Maternal Health</span></h1>
            <p class="header-subtitle">Comprehensive geospatial analysis of environmental exposures and their impact on maternal and placental outcomes across three Sub-Saharan African nations.</p>
            <div class="header-meta">
                <div class="meta-item">
                    <div class="meta-label">Study Sites</div>
                    <div class="meta-value">Kenya, Mozambique, The Gambia</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Participants</div>
                    <div class="meta-value">6,687 pregnant women</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Villages</div>
                    <div class="meta-value">525 communities</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Indicators</div>
                    <div class="meta-value">11 categories, 45+ variables</div>
                </div>
            </div>
            <div class="header-actions">
                <a href="https://docs.google.com/spreadsheets/d/1OuLxf76aZOfC74k85AkwM75pueAHXJPz/edit?usp=sharing&ouid=109068792255983589019&rtpof=true&sd=true" target="_blank" rel="noopener noreferrer" class="header-btn header-btn-primary">
                    <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 18H6V4h7v5h5v11zM8 15h8v2H8v-2zm0-4h8v2H8v-2z"/></svg>
                    Data Dictionary <span class="btn-note">(updating)</span>
                </a>
                <button onclick="openDataExplorer()" class="header-btn header-btn-primary">
                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    Data Explorer
                </button>
                <button onclick="openLightbox('https://raw.githubusercontent.com/Shmron/PRECISE/main/env_paper_inforgraphic2.jpg')" class="header-btn header-btn-secondary">
                    <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                    Variables at a Glance
                </button>
                <button onclick="sendInquiry()" class="header-btn header-btn-secondary">
                    <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                    Inquire About Catalogue
                </button>
            </div>
            <div class="regional-breakdown">
                <div class="regional-title">Regional Distribution</div>
                <div class="region-cards">
                    <div class="region-card kenya">
                        <div class="region-name"><span class="region-flag">&#127472;&#127466;</span> Kenya</div>
                        <div class="region-stats">
                            <div class="region-stat">
                                <span class="region-stat-label">Participants</span>
                                <span class="region-stat-value">3,194 (47.8%)</span>
                            </div>
                            <div class="region-stat">
                                <span class="region-stat-label">Communities</span>
                                <span class="region-stat-value">370</span>
                            </div>
                            <div class="region-stat">
                                <span class="region-stat-label">Settlement</span>
                                <span class="region-stat-value">66% Urban</span>
                            </div>
                        </div>
                        <div class="region-bar"><div class="region-bar-fill"></div></div>
                    </div>
                    <div class="region-card mozambique">
                        <div class="region-name"><span class="region-flag">&#127474;&#127487;</span> Mozambique</div>
                        <div class="region-stats">
                            <div class="region-stat">
                                <span class="region-stat-label">Participants</span>
                                <span class="region-stat-value">2,053 (30.7%)</span>
                            </div>
                            <div class="region-stat">
                                <span class="region-stat-label">Communities</span>
                                <span class="region-stat-value">74</span>
                            </div>
                            <div class="region-stat">
                                <span class="region-stat-label">Settlement</span>
                                <span class="region-stat-value">72% Urban</span>
                            </div>
                        </div>
                        <div class="region-bar"><div class="region-bar-fill"></div></div>
                    </div>
                    <div class="region-card gambia">
                        <div class="region-name"><span class="region-flag">&#127468;&#127474;</span> The Gambia</div>
                        <div class="region-stats">
                            <div class="region-stat">
                                <span class="region-stat-label">Participants</span>
                                <span class="region-stat-value">1,278 (19.1%)</span>
                            </div>
                            <div class="region-stat">
                                <span class="region-stat-label">Communities</span>
                                <span class="region-stat-value">81</span>
                            </div>
                            <div class="region-stat">
                                <span class="region-stat-label">Settlement</span>
                                <span class="region-stat-value">60% Rural</span>
                            </div>
                        </div>
                        <div class="region-bar"><div class="region-bar-fill"></div></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- ABSTRACT / INTRODUCTION SECTION -->
        <section class="abstract-section">
            <h2>Introduction</h2>
            <div class="abstract-content">
                <div class="abstract-column">
                    <h3>Global Maternal Health and Its Determinants</h3>
                    <p>Action on the determinants of health is a key global health priority including maternal health (1-3). Interventions that target these distal pathways to negative outcomes for pregnant women and their babies have generally received less attention compared to those clinical in nature. However, these nonclinical factors that affect pregnancy outcomes are many and affect different pregnancy outcomes in different ways. These determinants are a function of the woman's exposure to different characteristics of her environment.</p>
                    <p>Many epidemiological studies have suggested associations between environmental exposures and adverse maternal health outcomes. However, most of these studies have focussed on the physical environment in isolation. In this study we adopt a broad perspective to what constitutes the environment to encompass both the physical as well as social characteristics around the pregnant woman. The known environmental exposures attributed to disparities in maternal health outcomes exist both at individual as well as at community level and are a function of geography (4).</p>
                    <div class="abstract-highlight">
                        <p>Physical environmental risk factors implicated in negative pregnancy outcomes include exposure to heavy metals, air quality, flood proneness and spatial access to care. Prenatal exposure to heavy metals such as lead, mercury and cadmium is one of the strongest known risk factors for preeclampsia (5-8).</p>
                    </div>
                    <p>Air quality, in particular passive smoke from tobacco as well as household air pollution from use of solid fuels, has also been associated with preeclampsia, still births and low birth weight (9-11). A retrospective cohort study revealed significant positive correlations between physical isolation and flood proneness to adverse maternal health outcomes in Mozambique (12). This was also confirmed in studies investigating the effect of seasonal variation of spatial access to care on maternal health outcomes due to flooding (13, 14).</p>
                </div>
                <div class="abstract-column">
                    <h3>Geography, GIS and Global Maternal Health</h3>
                    <p>The Geo-Information Sciences largely emerged from need in the environmental sciences. GIS has grown to include capabilities for quantifying socio-geographical characteristics of places including characterization of social contexts and how these have an effect on maternal and other health outcomes (4, 18, 19).</p>
                    <p>The geospatial sciences present a unique opportunity for measuring aspects of a woman's environment that may contribute to risk for adverse pregnancy outcomes, including her physical and social environments. Geography and GIS are implicit in global health priorities that influence strategies for improving maternal health. The emphasis on eliciting local perspectives on the determinants of health is a new priority (3) that will elucidate how place and geographical context shapes maternal health outcomes.</p>
                    <div class="abstract-highlight">
                        <p>The emphasis on monitoring determinants and health outcomes at more disaggregate spatial levels to better target interventions (3) has presented new opportunities to further take advantage of GIS for understanding the distal pathways to adverse pregnancy outcomes.</p>
                    </div>
                    <h3>Methods</h3>
                    <p>This work was premised with a scoping review on the interactions between social and environmental exposures with outcomes related to placental disorders (20). The data for the indicators were generally presented either as vector or raster format, depending on the nature of the phenomenon to be represented (21). The vector data model presents spatial elements as points, lines and polygons whilst raster model presents data in grids or pixels (21, 22). Raster data type is best for the representation of continuous data like temperature from sources such as satellite imagery, while vector is best for discrete data like village points and roads (23).</p>
                </div>
            </div>
        </section>

        <main>
            <!-- POPULATION WEIGHTING METHODOLOGY -->
            <div class="methodology-sidebar">
                <h3>Population-Weighted Methodology Example</h3>
                <p class="methodology-intro">Environmental exposures are calculated using Carto's H3 hexagonal tessellation to account for heterogeneous population distribution within village boundaries. Each metric is weighted by the population residing in each grid cell, ensuring that densely populated areas have proportionally greater influence on the village-level estimate.</p>
                <div style="text-align: center; margin-top: 1.5rem;">
                    <img src="https://raw.githubusercontent.com/Shmron/PRECISE/main/Popullation%20Weighting%20Demo.png"
                         alt="Population Weighting Methodology using Carto H3 Hexagonal Tessellation"
                         style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 20px rgba(45, 52, 54, 0.1); cursor: pointer;"
                         onclick="openLightbox(this.src)"
                         title="Click to enlarge">
                    <p style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--slate);">Click image to enlarge</p>
                </div>
            </div>

            <!-- 1. AIR QUALITY -->
            <div class="category-section cat-air">
                <div class="category-header" onclick="toggleCategory(this)">
                    <div class="category-number">01</div>
                    <div class="category-title-wrapper">
                        <div class="category-icon">&#127811;</div>
                        <h2 class="category-title">Air Quality</h2>
                        <div class="category-count">15 indicators</div>
                    </div>
                    <div class="toggle-indicator">&#9660;</div>
                </div>
                <div class="variables-grid">
                    <!-- NDVI -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">NDVI</div>
                        <div class="variable-unit">Normalized Difference Vegetation Index (-1 to 1, unitless)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">0.02 [-0.01, 0.21] P95: 0.40</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">0.14 [-0.01, 0.39] P95: 0.57</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.13 [0.09, 0.17] P95: 0.30</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">0.12 [0.01, 0.21] P95: 0.46</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">Landsat7, Landsat 8, MODIS - MOD09GA/Q1, MODIS Terra Daily NDVI</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Residential greenness has been consistently associated with improved pregnancy outcomes and overall population health (Lee et al. 2020). Satellite-derived vegetation indices, particularly the Normalized Difference Vegetation Index (NDVI), are widely used as proxy measures of environmental quality and exposure to air pollution (Sedda et al. 2015). NDVI leverages the differential reflectance of vegetation in the visible red (RED) and near-infrared (NIR) spectral bands, with higher values indicating denser and healthier vegetation cover and, indirectly, lower levels of ambient air pollution.</p>
                                <div class="formula-display">NDVI = (NIR - RED) / (NIR + RED)

Village-level greenness was quantified by spatially
averaging NDVI values, calculated as the mean of all
NDVI pixels contained within each village boundary.</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Satellite-derived vegetation indices, particularly NDVI, are widely used as proxy measures of environmental quality and exposure to air pollution. Higher values indicate denser and healthier vegetation cover. NDVI values range from -1 to 1, where values closer to 1 indicate dense, healthy vegetation.</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Lee KJ, et al. (2020) Greenness, civil environment, and pregnancy outcomes. Environ Health 19:91. | Sedda L, et al. (2015) Poverty, health and satellite-derived vegetation indices. Int Health 7(2):99-106.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Distance to Highways -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Distance to Highways</div>
                        <div class="variable-unit">Population-Weighted Euclidean Distance (km)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">1.8 [0.5, 3.1] P95: 5.4</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">1.0 [0.4, 7.2] P95: 8.1</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.6 [0.6, 4.7] P95: 8.4</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">1.3 [0.5, 3.7] P95: 8.1</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">OSM Road dataset, WorldPop population raster, Village shapefile</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Residential proximity to major roadways is commonly used as a proxy for traffic-related air pollution exposure (Barnett et al. 2011). Epidemiological evidence indicates that women residing within proximity (e.g., 200m) to major roads experience an increased risk of adverse pregnancy outcomes, including preterm birth (Hitchins et al. 2000). Pollutants produced by motorized vehicles, such as carbon monoxide (CO), nitrogen oxide (NOx), hydrocarbons (HC), sulphur dioxide (SO2), lead (Pb) and carbon dioxide (CO2), have negative and dangerous impacts on the body (Rapang et al. 2023).</p>
                                <div class="formula-display">Distance_highway = (Population_i  Distance_i) / (Population_i)

where Distance_i represents the Euclidean distance from
grid cell i to the nearest highway.</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Traffic-related pollutant concentrations exhibit a strong spatial gradient, with highest levels adjacent to roads and a non-linear decay with increasing distance. Exposure to vehicle emissions, particularly carbon monoxide (CO), during pregnancy has been identified as a potential factor contributing to low birth weight in infants.</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Barnett AG, et al. (2011) Increased traffic exposure and negative birth outcomes. Environ Health 10:26. | Hitchins J, et al. (2000) Concentrations of submicrometre particles from vehicle emissions. Atmos Environ 34(1):51-9. | Rapang A, et al. (2023) Effect of CO exposure in pregnant women. J INFO Kesehat 21(4):713-20.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Distance to Major Roads -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Distance to Major Roads</div>
                        <div class="variable-unit">Population-Weighted Euclidean Distance (km)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">1.3 [0.5, 2.7] P95: 4.9</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">1.0 [0.4, 1.2] P95: 4.9</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.5 [0.5, 2.1] P95: 8.1</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">1.0 [0.4, 2.7] P95: 6.9</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">OSM Road dataset, WorldPop population data 100m resolution</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Population-weighted Euclidean distance to the nearest major road was computed using the same methodology as for highways, reflecting spatial variation in exposure to traffic-related pollution sources.</p>
                                <div class="formula-display">Distance_major_road = (Population_i  Distance_i) / (Population_i)

where Distance_i represents the Euclidean distance from
grid cell i to the nearest major road.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Elevation -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Elevation</div>
                        <div class="variable-unit">Altitude (meters above sea level)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">188.8 [169.2, 192.2] P95: 199.6</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">19.0 [18.6, 33.1] P95: 44.6</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">26.6 [15.3, 26.6] P95: 35.6</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">35.4 [19.9, 182.1] P95: 199.6</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">Digital Elevation Model (DEM) - MERIT/DEM/v1_0_3: Elevation in meters, referenced to EGM96 geoid model</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Elevation influences atmospheric pressure and air circulation patterns, which can affect the dispersion and concentration of air pollutants at a given location (Burton et al. 2025). Village-level altitude was derived by calculating the mean elevation pixel value within each village or neighbourhood boundary.</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>In addition to affecting air pollutant dispersion, exposure to high-altitude environments has been associated with adverse reproductive and pregnancy outcomes, including low birth weight and increased risk of pregnancy complications (Burton et al. 2025).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Burton GJ, et al. (2025) Pregnancy at high altitude: the challenge of hypoxia. Phil Trans R Soc B 380(1933):20240167.</p>
                            </div>
                        </div>
                    </div>

                    <!-- PM2.5 -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">PM2.5</div>
                        <div class="variable-unit">Fine Particulate Matter (&mu;g/m&sup3;)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">12.9 [10.2, 16.8] P95: 26.9</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">13.2 [8.7, 19.9] P95: 32.9</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">47.8 [30.6, 73.5] P95: 140.9</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">14.9 [10.5, 24.4] P95: 73.5</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">Global High Air Pollutants (GHAP) PM2.5 Concentrations, Copernicus Atmosphere Monitoring Service (CAMS) Global Reanalysis (EAC4)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Air pollution is one of the top five health risk factors, contributing to 6.67 million deaths worldwide in 2019 (Zhong et al. 2025). Pregnant women and neonates with exposure to high levels of air pollutants are at increased risk of adverse health outcomes such as maternal hypertensive disorders, postpartum depression, placental abruption, low birth weight, preterm birth, infant mortality, and adverse lung and respiratory effects (Aguilera et al. 2023). Metrics were calculated by spatially averaging within a village's boundary.</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Exposure to fine particulate matter (PM2.5) has been associated with adverse maternal and birth outcomes, including increased risk of gestational hypertension and reduced birth weight (Makanga et al. 2019). Inhalation of ambient PM2.5 has been shown to cross the placenta and has been linked to adverse obstetric and postnatal metabolic health outcomes (Kaur et al. 2022).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Zhong K, et al. (2025) Susceptible window identification of maternal ozone exposure and preterm birth. Int Health. | Aguilera J, et al. (2023) Air pollution and pregnancy. Semin Perinatol 47(8):151838. | Kaur K, et al. (2022) PM2.5 exposure during pregnancy and placental lipid metabolic genes. Environ Res 211:113066.</p>
                            </div>
                        </div>
                    </div>

                    <!-- PM2.5 Non-Fire Smoke -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Non-Fire Smoke PM2.5</div>
                        <div class="variable-unit">Background Particulate Matter (&mu;g/m&sup3;)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">5.2 [3.7, 8.0] P95: 16.6</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">4.2 [3.0, 6.2] P95: 12.7</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">42.2 [15.4, 67.9] P95: 115.5</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">5.3 [3.6, 11.1] P95: 67.1</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">Finnish Meteorological Institute (FMI) - Global smoke PM2.5 estimates</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Non-fire smoke PM2.5 represents background particulate matter from sources other than biomass burning, including industrial emissions, vehicle exhaust, and dust. This component contributes to chronic air pollution exposure during pregnancy.</p>
                            </div>
                        </div>
                    </div>

                    <!-- PM2.5 Fire Smoke -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Fire Smoke PM2.5</div>
                        <div class="variable-unit">Biomass Burning Particulate Matter (&mu;g/m&sup3;)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">0.0 [0.0, 0.1] P95: 0.6</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">0.1 [0.0, 0.4] P95: 2.0</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.1 [0.0, 0.6] P95: 1.9</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">0.1 [0.0, 0.2] P95: 1.5</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">Finnish Meteorological Institute (FMI) - Global smoke PM2.5 estimates</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Fire smoke PM2.5 captures particulate matter from biomass burning events including agricultural fires and wildfires. Seasonal burning patterns in sub-Saharan Africa can create acute exposure episodes during pregnancy.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Total AOD -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Total AOD</div>
                        <div class="variable-unit">Total Aerosol Optical Depth (dimensionless)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">0.2 [0.1, 0.2] P95: 0.4</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">0.1 [0.1, 0.1] P95: 0.4</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.3 [0.2, 0.5] P95: 0.8</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">0.2 [0.1, 0.3] P95: 0.5</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">CAMS Global Reanalysis (EAC4)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Aerosol Optical Depth (AOD) is a measure of the extinction of solar radiation by aerosols in the atmospheric column. Higher values indicate greater atmospheric particle loading from all sources.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Dust AOD -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Dust AOD</div>
                        <div class="variable-unit">Dust Aerosol Optical Depth (dimensionless)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">0.0 [0.0, 0.0] P95: 0.1</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">0.0 [0.0, 0.0] P95: 0.0</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.2 [0.1, 0.3] P95: 0.5</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">0.0 [0.0, 0.0] P95: 0.3</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">CAMS Global Reanalysis (EAC4)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Dust AOD specifically captures desert dust aerosols. The Gambia's proximity to the Sahara Desert explains its higher dust loading compared to East African sites.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Black Carbon AOD -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Black Carbon AOD</div>
                        <div class="variable-unit">Black Carbon Aerosol Optical Depth (dimensionless)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">0.0 [0.0, 0.0] P95: 0.0</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">0.0 [0.0, 0.0] P95: 0.0</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.0 [0.0, 0.0] P95: 0.0</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">0.0 [0.0, 0.0] P95: 0.0</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">CAMS Global Reanalysis (EAC4)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Black carbon aerosols originate primarily from incomplete combustion of fossil fuels and biomass burning. They contribute to respiratory and cardiovascular health impacts during pregnancy.</p>
                            </div>
                        </div>
                    </div>

                    <!-- CO -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Carbon Monoxide (CO)</div>
                        <div class="variable-unit">Total Column (g/m&sup2;)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">0.8 [0.7, 0.8] P95: 1.0</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">0.7 [0.7, 0.9] P95: 1.1</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">1.0 [0.9, 1.0] P95: 1.2</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">0.8 [0.7, 0.9] P95: 1.1</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">CAMS Global Reanalysis (EAC4)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>At a threshold of >2 ppm, CO was associated with lower mean birth-weight and higher rates of SGA and PTB, with a dose-response relationship (Galka et al. 2025). Acute CO poisoning in pregnant women is linked to complications such as preterm birth and miscarriage, with outcomes influenced by severity of maternal poisoning and stage of foetal development (Place et al. 2025). Exposure to vehicle emissions, particularly CO, during pregnancy has been identified as a potential factor contributing to low birth weight (Rapang et al. 2023).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Galka K, et al. (2025) Carbon monoxide levels and adverse pregnancy outcomes. Acta Obstet Gynecol Scand 104(12):2237-43. | Place E, et al. (2025) Carbon monoxide exposure in pregnant women in the UK. BMC Pregnancy Childbirth 25(1):1063.</p>
                            </div>
                        </div>
                    </div>

                    <!-- NO2 -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Nitrogen Dioxide (NO2)</div>
                        <div class="variable-unit">Total Column (&mu;mol/m&sup2;)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">0.02 [0.02, 0.03] P95: 0.03</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">0.03 [0.03, 0.04] P95: 0.07</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.05 [0.04, 0.05] P95: 0.07</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">0.03 [0.02, 0.04] P95: 0.06</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">CAMS Global Reanalysis (EAC4)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Short-term exposure to NO2 may induce increased risk of Spontaneous Abortion (SAB) outpatient visits, especially in elder women and cool seasons (Liang et al. 2021).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Liang Z, et al. (2021) Short-term ambient nitrogen dioxide exposure is associated with increased risk of spontaneous abortion. Ecotoxicol Environ Saf 224:112633.</p>
                            </div>
                        </div>
                    </div>

                    <!-- O3 -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Ozone (O3)</div>
                        <div class="variable-unit">Total Column (Dobson Units)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">265.2 [259.6, 270.0] P95: 276.3</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">272.1 [265.4, 283.4] P95: 297.2</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">268.9 [259.6, 276.5] P95: 287.0</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">267.6 [261.2, 274.0] P95: 290.0</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">CAMS Global Reanalysis (EAC4)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>There is some positive correlation between Ozone (O3) and Preterm Birth which is mostly pronounced during middle pregnancy (Zhong et al. 2025).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Zhong K, et al. (2025) Susceptible window identification of maternal ozone exposure and preterm birth. Int Health ihaf073.</p>
                            </div>
                        </div>
                    </div>

                    <!-- SO2 -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Sulfur Dioxide (SO2)</div>
                        <div class="variable-unit">Total Column (Dobson Units)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">0.0 [0.0, 0.0] P95: 0.0</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">0.1 [0.0, 0.1] P95: 0.3</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.1 [0.1, 0.2] P95: 0.3</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">0.0 [0.0, 0.1] P95: 0.2</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">CAMS Global Reanalysis (EAC4)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Sulfur dioxide (SO2) is a gaseous pollutant produced by fossil fuel combustion and volcanic activity. Exposure during pregnancy has been associated with respiratory symptoms and adverse birth outcomes.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Road Network Density -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Road Network Density</div>
                        <div class="variable-unit">Population-Weighted (km)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">4.0 [2.1, 17.5] P95: 20.9</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">9.9 [5.2, 11.7] P95: 11.7</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">12.6 [7.2, 18.0] P95: 18.0</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">9.0 [2.7, 13.1] P95: 19.1</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">OSM Road dataset, WorldPop population data 100m resolution</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Exposure to traffic-related pollution has been associated with increased risk of adverse pregnancy outcomes. Road density is commonly used as a spatial proxy for traffic intensity and associated vehicular emissions, with populations residing in communities with dense road networks experiencing higher exposure levels (Phillips et al. 2021).</p>
                                <div class="formula-display">Road Density_PW = (Population_i  RoadDensity_i) / (Population_i)

where RoadDensity_i represents road length per unit area
within grid cell i, and Population_i denotes the
population of grid cell i.</div>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Phillips BB, et al. (2021) Spatial extent of road pollution: A national analysis. Sci Total Environ 773:145589.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. SPATIAL ACCESS TO CARE -->
            <div class="category-section cat-anc">
                <div class="category-header" onclick="toggleCategory(this)">
                    <div class="category-number">02</div>
                    <div class="category-title-wrapper">
                        <div class="category-icon">&#127973;</div>
                        <h2 class="category-title">Spatial Access to Care</h2>
                        <div class="category-count">7 indicators</div>
                    </div>
                    <div class="toggle-indicator">&#9660;</div>
                </div>
                <div class="variables-grid">
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Road Quality Index</div>
                        <div class="variable-unit">RQI (0 to 1, dimensionless)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">0.5 [0.5, 0.6] P95: 0.6</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">0.4 [0.4, 0.5] P95: 0.5</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.4 [0.4, 0.5] P95: 0.7</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">0.5 [0.4, 0.5] P95: 0.6</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">OSM Road dataset, WorldPop population data 100m resolution</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Road Quality Index (RQI) is derived from OpenStreetMap road network data combined with WorldPop gridded population estimates. The index quantifies the quality of road infrastructure accessible to residential populations by weighting road segments by their estimated speed limits.</p>
                                <div class="formula-display">RQI = (RoadLength_i  SpeedLimit_i) / (RoadLength_i) / 120

where RoadLength_i is the length of road segment i,
SpeedLimit_i is the estimated speed limit (km/h) based on road class,
and 120 km/h normalizes to the maximum highway speed.

Lower RQI values indicate poorer road conditions.</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Road quality influences travel speed and accessibility to health facilities, with poorer road conditions associated with longer travel times and reduced access to maternal healthcare services. The quality of road infrastructure is a critical determinant of the "second delay" in maternal healthcare access - the delay in reaching an appropriate facility once the decision to seek care has been made (44).</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Walking Distance to Facility</div>
                        <div class="variable-unit">Population-Weighted Network Distance (km)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">3.0 [1.5, 4.4] P95: 28.7</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">3.6 [3.3, 5.6] P95: 23.3</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">1.6 [1.3, 6.7] P95: 11.6</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">3.1 [1.5, 5.1] P95: 22.2</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">OpenRouteService API (foot-walking profile), WorldPop 100m, Health facility locations from national registries</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Population-weighted walking distance to the nearest health facility providing maternal healthcare services. Distances are computed using network routing algorithms that account for pedestrian pathways and terrain.</p>
                                <div class="formula-display">PW_WalkDist_Fac = (Pop_i  WalkDist_i) / (Pop_i)

where Pop_i is population in grid cell i,
WalkDist_i is network walking distance from cell i centroid
to nearest health facility (km).</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Walking distance reflects accessibility for populations without motorized transport. In many sub-Saharan African settings, walking remains the primary mode of transport to health facilities, particularly for routine antenatal care visits (44).</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Walking Time to Facility</div>
                        <div class="variable-unit">Population-Weighted Network Time (minutes)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">35.7 [18.3, 52.9] P95: 344.3</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">43.7 [39.6, 67.3] P95: 280.1</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">19.2 [15.5, 80.1] P95: 139.4</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">37.7 [18.3, 61.2] P95: 266.1</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Walking time is derived from walking distance using a standard pedestrian walking speed assumption.</p>
                                <div class="formula-display">Walking Time (min) = Walking Distance (km)  60 / 5

Assumes average walking speed of 5 km/h, which is
consistent with WHO accessibility modeling standards.</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Time-based accessibility metrics capture the temporal dimension of healthcare access. Walking times exceeding 60 minutes have been associated with reduced antenatal care utilization and increased risk of home delivery without skilled attendance (44).</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Driving Distance to Facility</div>
                        <div class="variable-unit">Population-Weighted Network Distance (km)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">3.0 [1.5, 4.4] P95: 28.7</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">3.6 [3.3, 5.6] P95: 23.3</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">1.6 [1.3, 6.7] P95: 11.6</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">3.1 [1.5, 5.1] P95: 22.2</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">OpenRouteService API (driving-car profile), WorldPop 100m, Health facility locations from national registries</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Population-weighted driving distance to the nearest health facility using road network routing. Accounts for road network topology and driving restrictions.</p>
                                <div class="formula-display">PW_DriveDist_Fac = (Pop_i  DriveDist_i) / (Pop_i)

where DriveDist_i is the network driving distance from
cell i centroid to nearest health facility (km).</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Driving distance represents motorized accessibility, which is critical for emergency obstetric care and referrals. Longer driving distances correlate with delays in reaching emergency care for obstetric complications (44).</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Driving Time to Facility</div>
                        <div class="variable-unit">Population-Weighted Network Time (minutes)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">4.6 [3.6, 6.0] P95: 28.2</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">5.8 [5.8, 9.9] P95: 43.5</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">3.7 [2.1, 7.9] P95: 14.2</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">5.3 [3.6, 6.7] P95: 31.7</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Driving time is computed using network routing algorithms that account for road type, speed limits, and traffic patterns.</p>
                                <div class="formula-display">Driving Time = Network-based travel time estimate
using road-class-specific speed assumptions:
- Highways: 80-100 km/h
- Primary roads: 60-80 km/h
- Secondary roads: 40-60 km/h
- Tertiary/local roads: 20-40 km/h</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Travel time to nearest facility is a critical determinant of healthcare access. Delays reaching health facilities represent the "second delay" in Thaddeus and Maine's three-delays framework, which is known to elevate risks for adverse maternal outcomes (44).</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Public Transport Distance to Facility</div>
                        <div class="variable-unit">Population-Weighted Total Journey Distance (km)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">5.4 [2.2, 9.7] P95: 30.8</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">3.7 [3.1, 4.2] P95: 23.3</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">3.2 [1.5, 10.3] P95: 22.5</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">3.7 [1.8, 8.0] P95: 23.3</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Public transport accessibility models a multi-modal journey combining walking to a pickup point on a main road and vehicle travel to the facility.</p>
                                <div class="formula-display">TotalDist = WalkToPickup + InVehicleDist

where WalkToPickup is walking distance to nearest
primary/secondary road with public transport,
InVehicleDist is vehicle distance along roads.

Public transport assumed to operate only on
primary and secondary classified roads.</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Public transport represents the most common mode of motorized transport for pregnant women in resource-limited settings, particularly for planned antenatal visits. Accessibility via public transport captures the realistic journey patterns of women seeking maternal healthcare (44).</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Public Transport Time to Facility</div>
                        <div class="variable-unit">Population-Weighted Total Journey Time (minutes)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">39.2 [24.8, 63.9] P95: 121.2</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">30.4 [26.6, 38.5] P95: 124.4</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">29.1 [23.3, 54.1] P95: 146.9</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">33.7 [24.8, 58.0] P95: 126.9</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Total public transport journey time combines walking, waiting, and in-vehicle components to model realistic travel patterns.</p>
                                <div class="formula-display">TotalTime = WalkTime + WaitTime + VehicleTime

where:
- WalkTime = WalkDist / 5 km/h  60 (minutes)
- WaitTime = 20 minutes (fixed, for typical delays)
- VehicleTime = InVehicleDist / VehicleSpeed  60</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Public transport journey times capture the full temporal burden of healthcare access, including waiting periods that disproportionately affect pregnant women. Journey times exceeding 2 hours are associated with reduced ANC attendance and delayed emergency care seeking (44).</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 3. PHYSICAL ISOLATION -->
            <div class="category-section cat-anc">
                <div class="category-header" onclick="toggleCategory(this)">
                    <div class="category-number">03</div>
                    <div class="category-title-wrapper">
                        <div class="category-icon">&#128739;</div>
                        <h2 class="category-title">Physical Isolation</h2>
                        <div class="category-count">2 indicators</div>
                    </div>
                    <div class="toggle-indicator">&#9660;</div>
                </div>
                <div class="variables-grid">
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Isolation Walking Distance to Major Roads</div>
                        <div class="variable-unit">Population-Weighted Network Distance (km)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">1.9 [0.9, 4.4] P95: 10.1</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">1.3 [0.6, 1.9] P95: 15.2</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.7 [0.6, 2.6] P95: 10.4</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">1.3 [0.7, 3.9] P95: 10.1</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">OSM Road network (primary/secondary roads), WorldPop 100m</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Population-weighted walking distance to the nearest primary or secondary road, representing accessibility to major transport corridors.</p>
                                <div class="formula-display">PW_WalkIso_Major = (Pop_i  WalkDist_MajorRoad_i) / (Pop_i)

Major roads defined as OSM highway classes:
primary, primary_link, secondary, secondary_link</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Walking distance to major roads is a proxy for isolation from transport networks. Difficult access to roads is a known barrier to healthcare utilization, particularly affecting women's ability to access public transport for antenatal care (4, 12).</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Isolation Walking Distance to Highways</div>
                        <div class="variable-unit">Population-Weighted Network Distance (km)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">2.9 [0.9, 4.9] P95: 10.6</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">1.3 [0.6, 15.1] P95: 16.3</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.7 [0.7, 5.1] P95: 10.8</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">1.9 [0.7, 5.9] P95: 15.5</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">OSM Road network (trunk/motorway roads), WorldPop 100m</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Population-weighted walking distance to the nearest highway/trunk road, representing accessibility to national transport corridors.</p>
                                <div class="formula-display">PW_WalkIso_Highway = (Pop_i  WalkDist_Highway_i) / (Pop_i)

Highways defined as OSM highway classes:
motorway, motorway_link, trunk, trunk_link</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Walking distance to highways captures isolation from long-distance transport. Highways typically have inter-city bus services connecting to urban referral hospitals, which is critical for accessing higher-level emergency obstetric care (4, 12, 13).</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. HEAT EXPOSURE AND WEATHER -->
            <div class="category-section cat-temp">
                <div class="category-header" onclick="toggleCategory(this)">
                    <div class="category-number">04</div>
                    <div class="category-title-wrapper">
                        <div class="category-icon">&#127777;</div>
                        <h2 class="category-title">Heat Exposure and Weather</h2>
                        <div class="category-count">6 indicators (3 tiers)</div>
                    </div>
                    <div class="toggle-indicator">&#9660;</div>
                </div>
                <div class="variables-grid">
                    <!-- TIER 1: Physiologically Relevant Heat Stress -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <span class="tier-label tier-1">Tier 1 - Heat Stress</span>
                        <div class="variable-name">Wet Bulb Temperature</div>
                        <div class="variable-unit">Heat Stress Index (&deg;C)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">21.4 [19.8, 22.8] P95: 24.3</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">17.1 [14.3, 20.1] P95: 22.9</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">14.7 [8.6, 23.0] P95: 24.6</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">20.1 [16.4, 22.3] P95: 24.3</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">ERA-5, MERRA-2 (NASA/GSFC/MERRA/slv/2) - T2MWET band</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Tier 1 is based on Wet-bulb temperature, extreme hot days and heatwave days. High temperature and humidity increase the risk of adverse pregnancy outcomes, while lower values are generally protective (Basu et al. 2010). Wet-bulb temperature integrates heat and humidity and is a physiologically relevant measure of maternal heat stress (Sherwood & Huber 2010).</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Wet bulb temperature is a superior heat stress metric as it accounts for the body's inability to cool through sweating in humid conditions. Values above 32&deg;C are dangerous; above 35&deg;C is lethal for prolonged exposure. Pregnant women are especially vulnerable to heat stress. Extreme hot days and heatwaves capture acute and sustained thermal stress beyond average conditions and have been linked to increased risks of preterm birth and stillbirth (McElroy et al. 2022).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Basu R, et al. (2010) High ambient temperature and risk of preterm delivery. Am J Epidemiol 172(10). | Sherwood SC, Huber M. (2010) An adaptability limit to climate change due to heat stress. PNAS 107(21):9552-5. | McElroy S, et al. (2022) Extreme heat, preterm birth, and stillbirth. Environ Int 158:106902.</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <span class="tier-label tier-1">Tier 1 - Heat Stress</span>
                        <div class="variable-name">Extreme Hot Days</div>
                        <div class="variable-unit">Percentage of Pregnancy (%)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">5.0 [2.9, 6.7] P95: 8.6</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">4.2 [3.7, 6.6] P95: 7.7</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">4.1 [2.8, 7.2] P95: 9.6</span></div>
                            <div><span class="stats-label">Overall</span><span class="stats-value">4.5 [3.3, 6.7] P95: 8.7</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Percentage of pregnancy days exposed to extreme heat conditions. Extreme heat exposure during pregnancy affects fetal development through thermoregulatory stress and reduced placental blood flow.</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <span class="tier-label tier-1">Tier 1 - Heat Stress</span>
                        <div class="variable-name">Heatwave Days</div>
                        <div class="variable-unit">Percentage of Pregnancy (%)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">0.0 [0.0, 1.5] P95: 4.8</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">0.0 [0.0, 0.0] P95: 2.3</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.0 [0.0, 0.8] P95: 4.9</span></div>
                            <div><span class="stats-label">Overall</span><span class="stats-value">0.0 [0.0, 0.6] P95: 4.4</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Prolonged heat exposure during heatwave events poses significant risks to maternal and fetal health. Heatwaves are defined as consecutive days exceeding the local 95th percentile temperature threshold.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TIER 2: Ambient Air Temperature -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <span class="tier-label tier-2">Tier 2 - Ambient Air</span>
                        <div class="variable-name">Ambient Temperature</div>
                        <div class="variable-unit">Mean Air Temperature at 2m (&deg;C)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">27.3 [25.7, 28.3] P95: 29.3</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">24.1 [21.5, 26.5] P95: 29.1</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">27.6 [26.2, 28.7] P95: 30.3</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">26.7 [24.9, 28.2] P95: 29.5</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">ERA5-Land Hourly (ECMWF/ERA5_LAND/HOURLY)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Tier 2 is based on Ambient (2m) air temperature and Diurnal temperature. Ambient air temperature is used as an indicator of environmental heat exposure and has been associated with adverse pregnancy outcomes, with elevated temperatures increasing risk and lower temperatures showing protective effects (Basu et al. 2010).</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Low temperature and low humidity are protective against preterm birth, whereas high temperature increases risk. Evidence shows that estimated health effects are sensitive to the choice of temperature metric.</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <span class="tier-label tier-2">Tier 2 - Ambient Air</span>
                        <div class="variable-name">Diurnal Temperature</div>
                        <div class="variable-unit">Daily Temperature Range (&deg;C)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">6.7 [5.6, 8.0] P95: 10.3</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">8.9 [6.4, 11.8] P95: 14.9</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">12.5 [8.2, 14.5] P95: 16.6</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">7.7 [6.1, 10.8] P95: 15.2</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Diurnal temperature variation reflects intra-day thermal instability rather than absolute heat exposure.</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Exposure to elevated diurnal temperature variation has been shown to be significantly associated with adverse early-life respiratory outcomes, including childhood pneumonia, indicating an independent exposure pathway related to repeated thermoregulatory stress (Xu et al. 2014).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Xu Z, et al. (2014) Temperature variability and childhood pneumonia. Environ Health 13:51.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TIER 3: Surface Derived Temperature -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <span class="tier-label tier-3">Tier 3 - Surface Derived</span>
                        <div class="variable-name">Land Surface Temperature</div>
                        <div class="variable-unit">Surface Temperature (&deg;C)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">28.3 [28.3, 28.9] P95: 29.1</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">29.2 [29.2, 30.1] P95: 30.3</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">26.6 [25.9, 26.6] P95: 26.8</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">28.7 [28.3, 29.2] P95: 30.3</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">ERA 5, MODIS, Landsat7, Landsat8</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Tier 3 is based on Land Surface Temperature (LST). LST represents the radiative temperature of the Earth's surface and is influenced by land cover, vegetation, and urban form.</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>While LST does not directly represent ambient air temperature experienced by individuals, it provides valuable information on spatial heat patterns such as urban heat islands and localised heat accumulation, which shape pregnant women's exposure (Li & Bou-Zeid 2013).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Li D, Bou-Zeid E. (2013) Synergistic Interactions between Urban Heat Islands and Heat Waves. J Appl Meteorol Climatol 52(9):2051-64.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. PRECIPITATION -->
            <div class="category-section cat-precip">
                <div class="category-header" onclick="toggleCategory(this)">
                    <div class="category-number">05</div>
                    <div class="category-title-wrapper">
                        <div class="category-icon">&#127783;</div>
                        <h2 class="category-title">Precipitation</h2>
                        <div class="category-count">1 indicator</div>
                    </div>
                    <div class="toggle-indicator">&#9660;</div>
                </div>
                <div class="variables-grid">
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Precipitation</div>
                        <div class="variable-unit">Daily Rainfall (mm/day)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">0.0 [0.0, 0.0] P95: 11.8</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">0.0 [0.0, 0.7] P95: 12.6</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.0 [0.0, 0.7] P95: 15.9</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">0.0 [0.0, 0.4] P95: 13.0</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">PERSIANN-CDR (Precipitation Estimation from Remotely Sensed Information using Artificial Neural Networks - Climate Data Record)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Monthly precipitation values were spatially averaged at the village or neighbourhood level.</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Seasonal variations in precipitation have been associated with fluctuations in birth outcomes, including birth weight and length (Rashid et al. 2017). Rainfall affects food availability, disease transmission, and access to healthcare during wet seasons.</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Rashid H, et al. (2017) Temperature during pregnancy influences the fetal growth and birth size. Trop Med Health 45:1.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. RELATIVE HUMIDITY -->
            <div class="category-section cat-humid">
                <div class="category-header" onclick="toggleCategory(this)">
                    <div class="category-number">06</div>
                    <div class="category-title-wrapper">
                        <div class="category-icon">&#128167;</div>
                        <h2 class="category-title">Relative Humidity</h2>
                        <div class="category-count">1 indicator</div>
                    </div>
                    <div class="toggle-indicator">&#9660;</div>
                </div>
                <div class="variables-grid">
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Relative Humidity</div>
                        <div class="variable-unit">Percentage (%)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">72.4 [68.6, 76.6] P95: 82.7</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">69.8 [63.7, 75.0] P95: 82.3</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">55.6 [38.8, 77.7] P95: 87.2</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">70.9 [65.3, 76.2] P95: 84.2</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">ECMWF/ERA5_LAND/HOURLY</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <div class="formula-display">RH calculated using Magnus-Tetens approximation:
e_s(T) = exp((a  T)/(b + T))
e_s(T_d) = exp((a  T_d)/(b + T_d))
RH = 100  (e_s(T_dew) / e_s(T_air))

where T is air temperature (C), T_d is dew point
temperature (C), a=17.625, b=243.04</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Low relative humidity has been associated with reduced risk of preterm birth, whereas high relative humidity increases risk (Wu et al. 2023). Humidity affects thermal comfort, disease transmission, and food storage/safety.</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Wu Y, et al. (2023) Effects of ambient temperature and relative humidity on preterm birth. Front Public Health 11:1101283.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 7. SOIL MICRO-NUTRIENTS -->
            <div class="category-section cat-soil">
                <div class="category-header" onclick="toggleCategory(this)">
                    <div class="category-number">07</div>
                    <div class="category-title-wrapper">
                        <div class="category-icon">&#127793;</div>
                        <h2 class="category-title">Soil Micro-Nutrients</h2>
                        <div class="category-count">4 indicators</div>
                    </div>
                    <div class="toggle-indicator">&#9660;</div>
                </div>
                <div class="variables-grid">
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Calcium (Ca)</div>
                        <div class="variable-unit">Extractable Calcium (ppm)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">62.5 [61.7, 63.0] P95: 64.5</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">60.1 [60.1, 67.8] P95: 68.6</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">62.7 [61.5, 62.7] P95: 64.7</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">62.5 [61.6, 63.3] P95: 68.6</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">ISDASOIL/Africa/v1/calcium_extractable (iSDAsoil 30m Resolution)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Values for each raster are averaged per neighbourhood/village boundary.</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Soil calcium affects food crop mineral content. Calcium is critical during pregnancy for fetal bone development, blood clotting, and muscle function. Maternal calcium deficiency is associated with preeclampsia and low birth weight.</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Nitrogen (N)</div>
                        <div class="variable-unit">Total Nitrogen (g/kg)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">57.7 [56.2, 72.3] P95: 80.5</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">53.8 [52.9, 62.6] P95: 78.5</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">49.1 [48.3, 52.8] P95: 58.2</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">56.2 [52.9, 63.5] P95: 78.5</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">ISDASOIL/Africa/v1/nitrogen_total (iSDAsoil 30m Resolution)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Soil nitrogen is essential for plant protein synthesis and crop productivity. Low soil nitrogen contributes to food insecurity and maternal malnutrition.</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Phosphorus (P)</div>
                        <div class="variable-unit">Extractable Phosphorus (ppm)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">25.1 [23.6, 25.3] P95: 25.8</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">24.3 [24.1, 24.6] P95: 25.4</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">23.6 [23.6, 23.8] P95: 24.9</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">24.2 [23.6, 25.1] P95: 25.5</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">ISDASOIL/Africa/v1/phosphorus_extractable</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Phosphorus is essential for root development and crop yield. Deficient soils produce lower crop yields affecting household food security.</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Potassium (K)</div>
                        <div class="variable-unit">Extractable Potassium (ppm)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">46.2 [45.8, 46.4] P95: 47.2</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">45.3 [44.8, 47.8] P95: 49.4</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">41.8 [41.2, 42.2] P95: 42.2</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">45.8 [44.8, 46.4] P95: 48.3</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">ISDASOIL/Africa/v1/potassium_extractable</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Potassium regulates water uptake and disease resistance in plants, affecting agricultural productivity and food security.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 8. URBAN FORM -->
            <div class="category-section cat-urban">
                <div class="category-header" onclick="toggleCategory(this)">
                    <div class="category-number">08</div>
                    <div class="category-title-wrapper">
                        <div class="category-icon">&#127961;</div>
                        <h2 class="category-title">Urban Form</h2>
                        <div class="category-count">1 indicator</div>
                    </div>
                    <div class="toggle-indicator">&#9660;</div>
                </div>
                <div class="variables-grid">
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Settlement Classification</div>
                        <div class="variable-unit">Degree of Urbanization (categorical)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">Peri-Urban: 26.1% | Rural: 8.0% | Urban: 65.8%</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">Peri-Urban: 7.1% | Rural: 20.5% | Urban: 72.3%</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">Peri-Urban: 0.2% | Rural: 60.3% | Urban: 39.5%</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">Peri-Urban: 14.7% | Rural: 21.9% | Urban: 63.4%</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">Global Human Settlement Layer (JRC/GHSL/P2023A/GHS_SMOD/2025)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <div class="formula-display">Classification based on MODE (most frequent value):
- smod_code 22-30: URBAN
- smod_code 14-21: PERI-URBAN
- smod_code 11-13: RURAL</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>The ongoing urbanization worldwide is leading to an increasing number of pregnant women being exposed to higher levels of urban-related environmental hazards such as air pollution and noise, and at the same time, having less contact with natural environments. The urban environment during pregnancy may influence child's respiratory health (Li et al. 2025).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Li F, et al. (2025) The silent threat: effects of PM2.5 exposure on perinatal complications and neonatal outcomes. BMC Pregnancy Childbirth 25(1):686.</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 9. IPCC CLIMATE ZONE -->
            <div class="category-section cat-temp">
                <div class="category-header" onclick="toggleCategory(this)">
                    <div class="category-number">09</div>
                    <div class="category-title-wrapper">
                        <div class="category-icon">&#127758;</div>
                        <h2 class="category-title">IPCC Climate Zone</h2>
                        <div class="category-count">1 indicator</div>
                    </div>
                    <div class="toggle-indicator">&#9660;</div>
                </div>
                <div class="variables-grid">
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">IPCC Climate Zone</div>
                        <div class="variable-unit">Climate Classification (categorical)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Tropical Dry</span><span class="stats-value">Kenya: 97.2% | Mozambique: 99.9% | Gambia: 98.6% | All: 98.4%</span></div>
                            <div><span class="stats-label">Tropical Moist</span><span class="stats-value">Kenya: 1.0% | Mozambique: 0.0% | Gambia: 1.4% | All: 0.8%</span></div>
                            <div><span class="stats-label">Tropical Montane</span><span class="stats-value">Kenya: 0.4% | All: 0.2%</span></div>
                            <div><span class="stats-label">Warm Temperate Dry</span><span class="stats-value">Kenya: 1.2% | All: 0.6%</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">WorldPop Population Data, IPCC Climate Zones TIF</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Climate zones were assigned using the Intergovernmental Panel on Climate Change (IPCC) climate classification, based on long-term temperature and precipitation patterns (46). Village-level climate zones were determined using a population-weighted dominant classification.</p>
                                <div class="formula-display">Climate Zone = argmax_z [(Population_i | Climate_i = z)]

This method ensures assigned climate zones represent
conditions experienced by most village residents.</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Climate zone classification provides contextual information relevant to environmental exposures during pregnancy, including thermal regimes and seasonal variability (47).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">IPCC (2023) Climate Change 2021  The Physical Science Basis. Cambridge University Press. | Watts N, et al. (2019) The 2019 report of The Lancet Countdown on health and climate change. Lancet 394(10211):1836-78.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 10. WEALTH AND DEVELOPMENT INDICATORS -->
            <div class="category-section cat-urban">
                <div class="category-header" onclick="toggleCategory(this)">
                    <div class="category-number">10</div>
                    <div class="category-title-wrapper">
                        <div class="category-icon">&#128161;</div>
                        <h2 class="category-title">Wealth and Development Indicators</h2>
                        <div class="category-count">2 indicators</div>
                    </div>
                    <div class="toggle-indicator">&#9660;</div>
                </div>
                <div class="variables-grid">
                    <!-- VIIRS Night Lights -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">VIIRS Nighttime Lights</div>
                        <div class="variable-unit">Radiance (nW/cm/sr)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">3.0 [1.1, 5.6] P95: 6.7</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">2.9 [0.6, 6.6] P95: 8.7</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.5 [0.0, 1.6] P95: 1.7</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">1.9 [0.8, 5.5] P95: 8.3</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">ee.ImageCollection("NOAA/VIIRS/DNB/ANNUAL_V21"), WorldPop Population Data, Village Shapefiles</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>VIIRS nighttime light intensity is widely used as a proxy for human settlement density, infrastructure development, and socioeconomic activity. Nighttime lights correlate strongly with population distribution, electrification, income, and access to services (Jean et al. 2016).</p>
                                <div class="formula-display">NTL_PW = (Population_i  NTL_i) / (Population_i)

This population-weighted approach ensures nighttime light
estimates reflect conditions experienced by most
village residents rather than uninhabited areas.</div>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Jean N, et al. (2016) Combining satellite imagery and machine learning to predict poverty. Science 353(6301):790-4. | Chen X, Nordhaus WD. (2011) Using luminosity data as a proxy for economic statistics. PNAS 108(21):8589-94.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Relative Wealth Index -->
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Relative Wealth Index</div>
                        <div class="variable-unit">RWI (dimensionless, relative scale)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">0.6 [0.2, 0.8] P95: 1.0</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">0.3 [0.2, 0.4] P95: 0.9</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">-0.1 [-0.4, 0.5] P95: 0.5</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">0.3 [0.1, 0.6] P95: 1.0</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Dataset</h4>
                                <div class="dataset-info">WorldPop Population Data, Village Shapefiles, HDX Relative Wealth Index (93 Low and Middle Income Countries)</div>
                            </div>
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>The Relative Wealth Index (RWI) is a high-resolution, machine-learning-derived proxy of relative household wealth developed by Meta Data for Good and validated against Demographic and Health Survey (DHS) wealth indices (Jean et al. 2016). RWI provides a continuous measure of socioeconomic status, with values interpreted relative to the national wealth distribution.</p>
                                <div class="formula-display">RWI_PW = (Population_i  RWI_i) / (Population_i)

This population-weighted approach ensures wealth
estimates reflect socioeconomic conditions experienced
by most village residents.</div>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Village-level socioeconomic context was estimated using a population-weighted RWI, accounting for within-village population distribution (Victora et al. 2008; Marmot et al. 2008).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Jean N, et al. (2016) Combining satellite imagery and machine learning to predict poverty. Science 353(6301):790-4. | Victora CG, et al. (2008) Maternal and child undernutrition. Lancet 371(9609):340-57. | Marmot M, et al. (2008) Closing the gap in a generation. Lancet 372(9650):1661-9.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 11. SOCIO-GEOGRAPHIC CHARACTERISTICS -->
            <div class="category-section cat-social">
                <div class="category-header" onclick="toggleCategory(this)">
                    <div class="category-number">11</div>
                    <div class="category-title-wrapper">
                        <div class="category-icon">&#128101;</div>
                        <h2 class="category-title">Socio-Geographic Characteristics</h2>
                        <div class="category-count">8 indicators</div>
                    </div>
                    <div class="toggle-indicator">&#9660;</div>
                </div>
                <div class="variables-grid">
                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Social Inclusion</div>
                        <div class="variable-unit">Community Group Participation (%)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">3.8%</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">6.9%</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">9.3%</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">5.9%</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Proportion of pregnant women who are aware of and actively participate in community groups or organisations (formal or informal) that provide support for pregnancy-related problems. Derived from survey questions assessing awareness and active participation through meeting attendance, financial contributions, or advocacy.</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>This indicator captures social inclusion during pregnancy by reflecting engagement in community-based support and health promotion structures that help reduce social exclusion during the prenatal period (Victora et al. 2008).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Victora CG, et al. (2008) Maternal and child undernutrition. Lancet 371(9609):340-57.</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Community Help</div>
                        <div class="variable-unit">Bonding Social Capital (%)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">75.0%</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">51.3%</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">49.6%</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">62.7%</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Proportion of pregnant women who report having access to help from neighbours or other families in their community if pregnancy-related problems arise. Responses of "don't know" were recoded as "no" (yes=1; no/don't know=0).</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Bonding social capital (strong ties of trust with neighbours, family, friends) acts through psychosocial support mechanisms to improve pregnancy health (Schlmerich et al. 2014).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Schlmerich VLN, et al. (2014) Neighborhood Social Capital and Pregnancy Outcomes. PLoS ONE 9(5):e95873.</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">General Financial Autonomy</div>
                        <div class="variable-unit">Household Decision-Making (%)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">68.8%</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">50.6%</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">72.9%</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">64.0%</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Derived from the survey question: "Who makes the decisions about money in your household?" Women who identified themselves as the primary decision-maker were classified as having financial autonomy.</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Women who make household financial decisions have greater chances of receiving antenatal and delivery care. The indicator reflects women's financial autonomy, a key dimension of gender power relations (Girardi et al. 2023).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Girardi G, et al. (2023) Social determinants of health in pregnant individuals. Int J Equity Health 22(1):186.</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Pregnancy Financial Autonomy</div>
                        <div class="variable-unit">Pregnancy-Related Decision-Making (%)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">62.5%</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">54.2%</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">81.1%</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">63.7%</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Derived from the survey question: "Who makes decisions about money related to pregnancy and pregnancy care?" Women who identified themselves as the primary decision-maker were classified as having pregnancy-related financial autonomy.</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Women with financial autonomy on pregnancy-related issues have greater uptake of antenatal care, skilled birth attendance, use of maternal health services, and improved birth outcomes (Makanga et al. 2019).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Makanga PT, et al. (2019) Place-specific factors associated with adverse maternal and perinatal outcomes in Southern Mozambique. BMJ Open 9(2):e024042.</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Partner Availability</div>
                        <div class="variable-unit">Living with Partner (%)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">80.3%</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">63.1%</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">66.3%</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">72.1%</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Derived from survey questions assessing whether the respondent currently lives alone, and if not, whether she currently lives with a partner. This indicator captures physical partner availability through shared residence but does not capture non-cohabiting partner support.</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Pregnant women with involved partners are more likely to receive prenatal care. Partner involvement is associated with better neonatal outcomes and reduced maternal morbidity (Wang et al. 2020).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Wang E, et al. (2020) Social Determinants of Pregnancy-Related Mortality and Morbidity in the United States. Obstet Gynecol 135(4):896-915.</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Emotional Support</div>
                        <div class="variable-unit">Community Emotional Support (%)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">39.3%</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">23.8%</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">28.2%</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">32.5%</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Derived from the survey question on types of community support received, with women classified as receiving emotional support if they selected "emotional or moral support."</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Low social support is associated with depression, anxiety, and may indirectly raise risk for adverse birth outcomes through stress-related pathways (Bedaso et al. 2021).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Bedaso A, et al. (2021) The relationship between social support and mental health problems during pregnancy. Reprod Health 18(1):162.</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Transport Support</div>
                        <div class="variable-unit">Social Transport Access (%)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">25.1%</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">19.9%</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">17.5%</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">21.9%</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Derived from the survey question on types of community support received, with women classified as having transport support if "transport" was selected as a form of assistance.</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Emergency maternal transport services are essential for improving outcomes. Access to community-based transport support is critical for timely use of antenatal and emergency maternal health services (Girardi et al. 2023).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Girardi G, et al. (2023) Social determinants of health in pregnant individuals. Int J Equity Health 22(1):186.</p>
                            </div>
                        </div>
                    </div>

                    <div class="variable-card" onclick="toggleCard(this)">
                        <div class="variable-name">Financial Support</div>
                        <div class="variable-unit">Social Financial Support (%)</div>
                        <div class="stats-display">
                            <div><span class="stats-label">Kenya</span><span class="stats-value">5.4%</span></div>
                            <div><span class="stats-label">Mozambique</span><span class="stats-value">7.1%</span></div>
                            <div><span class="stats-label">The Gambia</span><span class="stats-value">0.4%</span></div>
                            <div><span class="stats-label">All Sites</span><span class="stats-value">4.9%</span></div>
                        </div>
                        <button class="expand-btn">View Details</button>
                        <div class="variable-details">
                            <div class="detail-section">
                                <h4>Methodology</h4>
                                <p>Derived from the survey question on types of community support received, with women classified as having financial support if "financial support" was selected as a form of assistance.</p>
                            </div>
                            <div class="detail-section">
                                <h4>Rationale</h4>
                                <p>Financial constraints significantly hinder women's access to antenatal care in low- and middle-income countries. Access to community-based financial support can reduce economic barriers to maternal health service use (Banke-Thomas et al. 2020).</p>
                            </div>
                            <div class="detail-section">
                                <h4>References</h4>
                                <p style="font-size: 0.85rem;">Banke-Thomas A, et al. (2020) Cost of Utilising Maternal Health Services in Low- and Middle-Income Countries. Int J Health Policy Manag.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- REFERENCES -->
        <div class="references-section">
            <h2>References</h2>
            <div class="reference-item"><span class="reference-number">1.</span> Lee KJ, Moon H, Yun HR, Park EL, Park AR, Choi H, et al. Greenness, civil environment, and pregnancy outcomes: perspectives with a systematic review and meta-analysis. Environ Health. 2020;19(1):91.</div>
            <div class="reference-item"><span class="reference-number">2.</span> Sedda L, Tatem AJ, Morley DW, Atkinson PM, Wardrop NA, Pezzulo C, et al. Poverty, health and satellite-derived vegetation indices: their inter-spatial relationship in West Africa. International Health. 2015;7(2):99-106.</div>
            <div class="reference-item"><span class="reference-number">3.</span> Barnett AG, Plonka K, Seow WK, Wilson LA, Hansen C. Increased traffic exposure and negative birth outcomes: a prospective cohort in Australia. Environ Health. 2011;10(1):26.</div>
            <div class="reference-item"><span class="reference-number">4.</span> Hitchins J, Morawska L, Wolff R, Gilbert D. Concentrations of submicrometre particles from vehicle emissions near a major road. Atmos Environ. 2000;34(1):51-9.</div>
            <div class="reference-item"><span class="reference-number">5.</span> Rapang A, Bara FT, Kusmiyati Y, Supahar S, Nopiyanti N. The Effect of Exposure to Carbon Monoxide (CO) Gas in Pregnant Women on The Incident of Weight Infants Born in Makassar City. J INFO Kesehat. 2023;21(4):713-20.</div>
            <div class="reference-item"><span class="reference-number">6.</span> Phillips BB, Bullock JM, Osborne JL, Gaston KJ. Spatial extent of road pollution: A national analysis. Sci Total Environ. 2021;773:145589.</div>
            <div class="reference-item"><span class="reference-number">7.</span> Burton GJ, Moore LG, Giussani DA, Murray AJ. Pregnancy at high altitude: the challenge of hypoxia. Phil Trans R Soc B. 2025;380(1933):20240167.</div>
            <div class="reference-item"><span class="reference-number">8.</span> Zhong K, Yang R, Liu X, He J, Wen C, Zhu Z, et al. Susceptible window identification of the relationship between maternal ozone exposure and preterm birth. Int Health. 2025;ihaf073.</div>
            <div class="reference-item"><span class="reference-number">9.</span> Aguilera J, Konvinse K, Lee A, Maecker H, Prunicki M, Mahalingaiah S, et al. Air pollution and pregnancy. Semin Perinatol. 2023;47(8):151838.</div>
            <div class="reference-item"><span class="reference-number">10.</span> Makanga PT, Sacoor C, Schuurman N, Lee T, Vilanculo FC, Munguambe K, et al. Place-specific factors associated with adverse maternal and perinatal outcomes in Southern Mozambique: a retrospective cohort study. BMJ Open. 2019;9(2):e024042.</div>
            <div class="reference-item"><span class="reference-number">11.</span> Kaur K, Lesseur C, Deyssenroth MA, Kloog I, Schwartz JD, Marsit CJ, et al. PM2.5 exposure during pregnancy is associated with altered placental expression of lipid metabolic genes. Environ Res. 2022;211:113066.</div>
            <div class="reference-item"><span class="reference-number">12.</span> Galka K, Shea M, Aye CYL, Impey L. Carbon monoxide levels, smoking and adverse pregnancy outcomes. Acta Obstet Gynecol Scand. 2025;104(12):2237-43.</div>
            <div class="reference-item"><span class="reference-number">13.</span> Place E, Wareing H, Herigstad M. Carbon monoxide exposure in pregnant women in the UK. BMC Pregnancy Childbirth. 2025;25(1):1063.</div>
            <div class="reference-item"><span class="reference-number">14.</span> Liang Z, Xu C, Liang S, Cai TJ, Yang N, Li SD, et al. Short-term ambient nitrogen dioxide exposure is associated with increased risk of spontaneous abortion. Ecotoxicol Environ Saf. 2021;224:112633.</div>
            <div class="reference-item"><span class="reference-number">15.</span> Basu R, Malig B, Ostro B. High Ambient Temperature and the Risk of Preterm Delivery. Am J Epidemiol. 2010;172(10).</div>
            <div class="reference-item"><span class="reference-number">16.</span> Sherwood SC, Huber M. An adaptability limit to climate change due to heat stress. PNAS. 2010;107(21):9552-5.</div>
            <div class="reference-item"><span class="reference-number">17.</span> McElroy S, Ilango S, Dimitrova A, Gershunov A, Benmarhnia T. Extreme heat, preterm birth, and stillbirth: A global analysis across 14 lower-middle income countries. Environ Int. 2022;158:106902.</div>
            <div class="reference-item"><span class="reference-number">18.</span> Xu Z, Hu W, Tong S. Temperature variability and childhood pneumonia: an ecological study. Environ Health. 2014;13(1):51.</div>
            <div class="reference-item"><span class="reference-number">19.</span> Li D, Bou-Zeid E. Synergistic Interactions between Urban Heat Islands and Heat Waves: The Impact in Cities Is Larger than the Sum of Its Parts. J Appl Meteorol Climatol. 2013;52(9):2051-64.</div>
            <div class="reference-item"><span class="reference-number">20.</span> Wu Y, Yuan J, Yuan Y, Kong C, Jing W, Liu J, et al. Effects of ambient temperature and relative humidity on preterm birth during early pregnancy and before parturition in China. Front Public Health. 2023;11:1101283.</div>
            <div class="reference-item"><span class="reference-number">21.</span> Rashid H, Kagami M, Ferdous F, Ma E, Terao T, Hayashi T, et al. Temperature during pregnancy influences the fetal growth and birth size. Trop Med Health. 2017;45(1):1.</div>
            <div class="reference-item"><span class="reference-number">22.</span> Olapoju OM. Access to healthcare and impediment(s) of transport: examining lived experience of pregnant women in selected local governments of Oyo state, Nigeria. Discov Health Syst. 2025;4(1):17.</div>
            <div class="reference-item"><span class="reference-number">23.</span> Li F, Liu X, Gong S, Li P, Gao Y, Guo X, et al. The silent threat: effects of PM2.5 exposure on perinatal complications and neonatal outcomes. BMC Pregnancy Childbirth. 2025;25(1):686.</div>
            <div class="reference-item"><span class="reference-number">24.</span> IPCC. Climate Change 2021  The Physical Science Basis: Working Group I Contribution to the Sixth Assessment Report. Cambridge University Press; 2023.</div>
            <div class="reference-item"><span class="reference-number">25.</span> Watts N, Amann M, Arnell N, Ayeb-Karlsson S, Belesova K, Boykoff M, et al. The 2019 report of The Lancet Countdown on health and climate change. Lancet. 2019;394(10211):1836-78.</div>
            <div class="reference-item"><span class="reference-number">26.</span> Jean N, Burke M, Xie M, Davis WM, Lobell DB, Ermon S. Combining satellite imagery and machine learning to predict poverty. Science. 2016;353(6301):790-4.</div>
            <div class="reference-item"><span class="reference-number">27.</span> Chen X, Nordhaus WD. Using luminosity data as a proxy for economic statistics. PNAS. 2011;108(21):8589-94.</div>
            <div class="reference-item"><span class="reference-number">28.</span> Victora CG, Adair L, Fall C, Hallal PC, Martorell R, Richter L, et al. Maternal and child undernutrition: consequences for adult health and human capital. Lancet. 2008;371(9609):340-57.</div>
            <div class="reference-item"><span class="reference-number">29.</span> Marmot M, Friel S, Bell R, Houweling TAJ, Taylor S. Closing the gap in a generation: health equity through action on the social determinants of health. Lancet. 2008;372(9650):1661-9.</div>
            <div class="reference-item"><span class="reference-number">30.</span> Schlmerich VLN, Erdem , Borsboom G, Ghorashi H, Groenewegen P, Steegers EAP, et al. The Association of Neighborhood Social Capital and Ethnic (Minority) Density with Pregnancy Outcomes in the Netherlands. PLoS ONE. 2014;9(5):e95873.</div>
            <div class="reference-item"><span class="reference-number">31.</span> Girardi G, Longo M, Bremer AA. Social determinants of health in pregnant individuals from underrepresented, understudied, and underreported populations in the United States. Int J Equity Health. 2023;22(1):186.</div>
            <div class="reference-item"><span class="reference-number">32.</span> Wang E, Glazer KB, Howell EA, Janevic TM. Social Determinants of Pregnancy-Related Mortality and Morbidity in the United States: A Systematic Review. Obstet Gynecol. 2020;135(4):896-915.</div>
            <div class="reference-item"><span class="reference-number">33.</span> Bedaso A, Adams J, Peng W, Sibbritt D. The relationship between social support and mental health problems during pregnancy: a systematic review and meta-analysis. Reprod Health. 2021;18(1):162.</div>
            <div class="reference-item"><span class="reference-number">34.</span> Banke-Thomas A, Ayomoh FI, Abejirinde IOO, Banke-Thomas O, Eboreime EA, Ameh CA. Cost of Utilising Maternal Health Services in Low- and Middle-Income Countries: A Systematic Review. Int J Health Policy Manag. 2020.</div>
            <div class="reference-item"><span class="reference-number">35.</span> Gage AJ, Guirlene Calixte M. Physical accessibility of maternal health services. Popul Stud. 2006;60(3):271-88.</div>
            <div class="reference-item"><span class="reference-number">36.</span> Rylander C, Odland J, Sandanger TM. Climate change and maternal and pregnancy outcomes. Glob Health Action. 2013;6(1):1-9.</div>
        </div>

        <footer>
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Authors</h3>
                    <p>Makanga PT, Makacha L, Mlambo R, Nyapwere N, Dube YP, Craik R, Misty H, Magee LA, Barrat B, von Dadelszen P</p>
                </div>
                <div class="footer-section">
                    <h3>Affiliations</h3>
                    <p>PRECISE Network | Midlands State University (Zimbabwe) | Centre for Sexual Health HIV and AIDS Research Zimbabwe (CeSHHAR Zimbabwe) | King's College London | Imperial College London | University of British Columbia</p>
                </div>
                <div class="footer-section">
                    <h3>Funding</h3>
                    <p>United Kingdom Research and Innovation GCRF GROW award (MR/P027938/1)</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Lightbox for Image Enlargement -->
    <div class="lightbox" id="imageLightbox" onclick="closeLightbox()">
        <span class="lightbox-close" onclick="event.stopPropagation(); closeLightbox()">&times;</span>
        <div class="lightbox-hint">Click image to zoom in/out &bull; Scroll to navigate &bull; Click outside to close</div>
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <img id="lightboxImg" src="" alt="Enlarged view" onclick="toggleZoom(this)">
        </div>
        <div class="lightbox-controls" onclick="event.stopPropagation()">
            <button class="lightbox-btn" onclick="zoomIn()">+ Zoom In</button>
            <button class="lightbox-btn" onclick="zoomOut()">- Zoom Out</button>
            <button class="lightbox-btn" onclick="resetZoom()"> Reset</button>
        </div>
    </div>

    <!-- Query Builder Modal -->
    <div class="explorer-overlay" id="explorerOverlay">
        <div class="explorer-modal">
            <div class="explorer-header">
                <h2>Explore Participant Data</h2>
                <button class="explorer-close" onclick="closeDataExplorer()">&times;</button>
            </div>
            <div class="explorer-body">
                <div class="explorer-loading" id="explorerLoading">Loading participant data...</div>
                <div id="explorerContent" style="display:none;">

                    <!-- Ask Shmron - Primary Query Interface -->
                    <div class="qb-section">
                        <div class="qb-section-title" style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2rem;">&#129302;</span>
                            Ask Shmron
                            <span style="font-weight: normal; font-size: 0.75rem; color: var(--teal-mid); margin-left: 0.5rem;">AI-powered queries</span>
                        </div>
                        <div class="qb-nl-query">
                            <input type="text" id="qbNLQuery" placeholder="e.g., 'Rural participants in Kenya with PM2.5 above 30' or 'Compare temperature across countries'" style="flex:1; padding: 0.8rem 1rem; border: 2px solid var(--teal-mid); border-radius: 6px; font-size: 0.95rem;">
                            <button class="qb-btn qb-btn-ai" onclick="runNLQuery()" style="background: linear-gradient(135deg, var(--teal-deep) 0%, var(--teal-mid) 100%); color: white; display: flex; align-items: center; gap: 0.5rem; padding: 0.8rem 1.2rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                                Ask
                            </button>
                        </div>
                        <div class="qb-suggestions" style="margin-top: 0.6rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="document.getElementById('qbNLQuery').value='How many participants have PM2.5 above WHO guidelines (15)?'; runNLQuery();" style="padding: 0.3rem 0.7rem; background: var(--sand); border: 1px solid var(--mist); border-radius: 15px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;">PM2.5 > WHO limit</button>
                            <button onclick="document.getElementById('qbNLQuery').value='Compare walking time to facilities between urban and rural'; runNLQuery();" style="padding: 0.3rem 0.7rem; background: var(--sand); border: 1px solid var(--mist); border-radius: 15px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;">Urban vs Rural access</button>
                            <button onclick="document.getElementById('qbNLQuery').value='Which country has highest heat exposure?'; runNLQuery();" style="padding: 0.3rem 0.7rem; background: var(--sand); border: 1px solid var(--mist); border-radius: 15px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;">Heat by country</button>
                            <button onclick="document.getElementById('qbNLQuery').value='Top 10% of temperature exposure'; runNLQuery();" style="padding: 0.3rem 0.7rem; background: var(--sand); border: 1px solid var(--mist); border-radius: 15px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;">Top 10% heat</button>
                        </div>
                        <div id="qbNLResponse" style="margin-top: 0.75rem; padding: 1rem; background: var(--sand); border-radius: 6px; display: none; font-size: 0.9rem; line-height: 1.6;"></div>
                    </div>

                    <!-- Quick Filters -->
                    <div class="qb-section">
                        <div class="qb-section-title">Quick Filters</div>
                        <div class="qb-base-filters" style="grid-template-columns: repeat(2, 1fr);">
                            <div class="qb-filter">
                                <label>Country</label>
                                <select id="qbCountry" onchange="runQuery()">
                                    <option value="all">All Countries</option>
                                    <option value="Ken">Kenya (n=3,194)</option>
                                    <option value="Moz">Mozambique (n=2,053)</option>
                                    <option value="Gam">The Gambia (n=1,278)</option>
                                </select>
                            </div>
                            <div class="qb-filter">
                                <label>Settlement Type</label>
                                <select id="qbSettlement" onchange="runQuery()">
                                    <option value="all">All Types</option>
                                    <option value="Urban">Urban (63%)</option>
                                    <option value="Rural">Rural (22%)</option>
                                    <option value="Peri-Urban">Peri-Urban (15%)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden elements for compatibility -->
                    <select id="qbClimate" style="display:none;"><option value="all">All</option></select>
                    <div id="qbActiveFilters" style="display:none;"></div>

                    <!-- Action Buttons -->
                    <div class="qb-actions">
                        <button class="qb-btn qb-btn-secondary" onclick="clearFilters()">Reset Filters</button>
                        <button class="qb-btn qb-btn-export" onclick="exportResults()">Export Results (CSV)</button>
                    </div>

                    <!-- Results -->
                    <div class="qb-results" id="qbResults">
                        <div class="qb-results-header">
                            <div class="qb-results-count">
                                Matching: <strong id="resultCount">0</strong> of 6,687 participants
                            </div>
                            <div class="qb-results-percent" id="resultPercent">0%</div>
                        </div>
                        <div class="qb-results-breakdown">
                            <div class="qb-country-card kenya">
                                <div class="qb-country-name">Kenya</div>
                                <div class="qb-country-value" id="resultKenya">0</div>
                                <div class="qb-country-pct" id="resultKenyaPct">0% of Kenya</div>
                            </div>
                            <div class="qb-country-card mozambique">
                                <div class="qb-country-name">Mozambique</div>
                                <div class="qb-country-value" id="resultMoz">0</div>
                                <div class="qb-country-pct" id="resultMozPct">0% of Mozambique</div>
                            </div>
                            <div class="qb-country-card gambia">
                                <div class="qb-country-name">The Gambia</div>
                                <div class="qb-country-value" id="resultGam">0</div>
                                <div class="qb-country-pct" id="resultGamPct">0% of Gambia</div>
                            </div>
                        </div>
                        <div class="qb-stats" id="qbStats"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleCategory(header) {
            header.classList.toggle('active');
            const grid = header.nextElementSibling;
            grid.classList.toggle('active');
        }

        function toggleCard(card) {
            if (window.event) window.event.stopPropagation();
            card.classList.toggle('expanded');
        }

        // ============================================
        // IMAGE LIGHTBOX WITH ZOOM
        // ============================================
        let currentZoom = 1;
        const zoomStep = 0.5;
        const maxZoom = 4;
        const minZoom = 0.5;

        function openLightbox(src) {
            currentZoom = 1;
            const img = document.getElementById('lightboxImg');
            img.src = src;
            img.style.transform = 'scale(1)';
            img.classList.remove('zoomed');
            document.getElementById('imageLightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('imageLightbox').classList.remove('active');
            document.body.style.overflow = '';
            currentZoom = 1;
        }

        function toggleZoom(img) {
            if (currentZoom === 1) {
                currentZoom = 2;
                img.style.transform = 'scale(2)';
                img.classList.add('zoomed');
            } else {
                currentZoom = 1;
                img.style.transform = 'scale(1)';
                img.classList.remove('zoomed');
            }
        }

        function zoomIn() {
            if (currentZoom < maxZoom) {
                currentZoom += zoomStep;
                document.getElementById('lightboxImg').style.transform = `scale(${currentZoom})`;
            }
        }

        function zoomOut() {
            if (currentZoom > minZoom) {
                currentZoom -= zoomStep;
                document.getElementById('lightboxImg').style.transform = `scale(${currentZoom})`;
            }
        }

        function resetZoom() {
            currentZoom = 1;
            const img = document.getElementById('lightboxImg');
            img.style.transform = 'scale(1)';
            img.classList.remove('zoomed');
        }

        // ============================================
        // QUERY BUILDER
        // ============================================
        let participantData = null;
        let filteredData = null;
        let activeFilters = [];
        const countryTotals = { Ken: 3194, Moz: 2053, Gam: 1278 };

        const variableLabels = {
            // Air Quality
            pm25: 'PM2.5 Mean', pm25_p95: 'PM2.5 P95', pm25_max: 'PM2.5 Max',
            pm25_d15: 'Days PM2.5>15 (WHO)', pm25_d25: 'Days PM2.5>25',
            pm25_d35: 'Days PM2.5>35', pm25_d50: 'Days PM2.5>50', pm25_d100: 'Days PM2.5>100',
            pm25_fire: 'Fire Smoke PM2.5', pm25_nonfire: 'Non-Fire PM2.5',
            no2: 'NO2', o3: 'Ozone', co: 'CO', so2: 'SO2',
            aod: 'AOD Total', aod_dust: 'Dust AOD', aod_bc: 'Black Carbon AOD',
            // Temperature
            temp: 'Temp Mean', temp_max: 'Temp Max', temp_min: 'Temp Min', temp_p95: 'Temp P95',
            temp_diurnal: 'Diurnal Temp Range',
            temp_d28: 'Days T>28C', temp_d30: 'Days T>30C', temp_d32: 'Days T>32C', temp_d35: 'Days T>35C',
            // Wet Bulb / Heat Stress
            wetbulb: 'Wet Bulb Mean', wetbulb_max: 'Wet Bulb Max',
            wb_d20: 'Days WB>20C', wb_d25: 'Days WB>25C', wb_d28: 'Days WB>28C',
            lst: 'Land Surface Temp',
            // Heatwave
            extreme_hot_days: 'Extreme Hot Days', heatwave_days: 'Heatwave Days',
            temp_deviation: 'Temp Deviation',
            // Weather
            humidity: 'Humidity', hum_d80: 'Days Hum>80%', hum_d90: 'Days Hum>90%',
            precip: 'Precipitation', rain_d1: 'Rainy Days (>1mm)', rain_d5: 'Heavy Rain Days (>5mm)', rain_d10: 'Very Heavy Rain (>10mm)',
            // Environment
            ndvi: 'NDVI (Vegetation)', elevation: 'Elevation',
            // Access
            walk_dist: 'Walking Distance', walk_time: 'Walking Time',
            drive_dist: 'Driving Distance', drive_time: 'Driving Time',
            pt_dist: 'Public Transport Dist', pt_time: 'Public Transport Time',
            dist_hwy: 'Distance to Highway', dist_road: 'Distance to Major Road',
            road_dens: 'Road Density', road_qual: 'Road Quality Index',
            // Isolation
            walk_iso_rd: 'Walk Isolation (Road)', walk_iso_hwy: 'Walk Isolation (Highway)',
            drive_iso_rd: 'Drive Isolation (Road)', drive_iso_hwy: 'Drive Isolation (Highway)',
            isolation: 'Isolation Index',
            // Socioeconomic
            rwi: 'Relative Wealth Index', viirs: 'Night Lights (VIIRS)', ppi: 'Poverty Probability Index',
            // Soil
            soil_ca: 'Soil Calcium', soil_n: 'Soil Nitrogen',
            soil_p: 'Soil Phosphorus', soil_k: 'Soil Potassium',
            // Demographics
            age: 'Age at Enrollment', n: 'Exposure Days'
        };

        function openDataExplorer() {
            document.getElementById('explorerOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
            if (!participantData) {
                loadParticipantData();
            } else {
                // Data already loaded (e.g., by chatbot), show content directly
                document.getElementById('explorerLoading').style.display = 'none';
                document.getElementById('explorerContent').style.display = 'block';
                renderFilters();
            }
        }

        function closeDataExplorer() {
            document.getElementById('explorerOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        async function loadParticipantData() {
            const loadingEl = document.getElementById('explorerLoading');
            try {
                loadingEl.innerHTML = 'Loading participant data (3.7 MB)...<br><small style="color: var(--slate);">This may take a moment on slower connections</small>';

                const url = 'https://raw.githubusercontent.com/Shmron/PRECISE/main/participant_data_expanded.json?v=' + Date.now();
                console.log('Fetching participant data from:', url);

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const json = await response.json();
                participantData = json.data;
                console.log('Loaded', participantData.length, 'participants');

                loadingEl.style.display = 'none';
                document.getElementById('explorerContent').style.display = 'block';
                renderFilters(); // Initialize the filters display
            } catch (error) {
                console.error('Failed to load participant data:', error);
                loadingEl.innerHTML = `
                    <div style="color: var(--coral); margin-bottom: 1rem;">
                        <strong>Error loading data:</strong> ${error.message}
                    </div>
                    <button onclick="loadParticipantData()" style="padding: 0.5rem 1rem; background: var(--teal-deep); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Try Again
                    </button>
                `;
            }
        }

        // Toggle second value input for 'between' operator
        function toggleBetweenInput() {
            const operator = document.getElementById('qbOperator').value;
            const value2Input = document.getElementById('qbValue2');
            const value1Input = document.getElementById('qbValue');

            if (operator === 'between') {
                value2Input.style.display = 'inline-block';
                value1Input.placeholder = 'Min value';
            } else if (operator === 'top%' || operator === 'bottom%') {
                value2Input.style.display = 'none';
                value1Input.placeholder = 'Percentile (e.g., 10)';
            } else {
                value2Input.style.display = 'none';
                value1Input.placeholder = 'Value';
            }
        }

        function addFilter() {
            const variable = document.getElementById('qbVariable').value;
            const operator = document.getElementById('qbOperator').value;
            const value = document.getElementById('qbValue').value;
            const value2 = document.getElementById('qbValue2').value;

            if (!value || isNaN(parseFloat(value))) {
                alert('Please enter a valid number');
                return;
            }

            if (operator === 'between' && (!value2 || isNaN(parseFloat(value2)))) {
                alert('Please enter both min and max values for range filter');
                return;
            }

            const filter = { variable, operator, value: parseFloat(value) };

            if (operator === 'between') {
                filter.value2 = parseFloat(value2);
            }

            // For percentile operators, calculate the threshold
            if (operator === 'top%' || operator === 'bottom%') {
                if (!participantData) {
                    alert('Data not loaded yet. Please wait.');
                    return;
                }
                const values = participantData.map(p => p[variable]).filter(v => v != null).sort((a, b) => a - b);
                const pct = parseFloat(value) / 100;
                if (operator === 'top%') {
                    const idx = Math.floor(values.length * (1 - pct));
                    filter.threshold = values[idx];
                    filter.displayOp = `top ${value}%`;
                } else {
                    const idx = Math.floor(values.length * pct);
                    filter.threshold = values[idx];
                    filter.displayOp = `bottom ${value}%`;
                }
            }

            activeFilters.push(filter);
            renderFilters();
            document.getElementById('qbValue').value = '';
            document.getElementById('qbValue2').value = '';

            // Auto-run query after adding filter
            runQuery();
        }

        // Allow Enter key to add filter
        document.addEventListener('DOMContentLoaded', function() {
            const valueInput = document.getElementById('qbValue');
            if (valueInput) {
                valueInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addFilter();
                    }
                });
            }
        });

        function removeFilter(index) {
            activeFilters.splice(index, 1);
            renderFilters();
        }

        function clearFilters() {
            activeFilters = [];
            document.getElementById('qbCountry').value = 'all';
            document.getElementById('qbSettlement').value = 'all';
            document.getElementById('qbClimate').value = 'all';
            document.getElementById('qbNLQuery').value = '';
            document.getElementById('qbNLResponse').style.display = 'none';
            renderFilters();
            runQuery(); // Refresh results to show all participants
        }

        function renderFilters() {
            const container = document.getElementById('qbActiveFilters');
            if (activeFilters.length === 0) {
                container.innerHTML = '<span style="color: var(--slate); font-style: italic;">No custom filters. Add filters above or use base filters.</span>';
            } else {
                container.innerHTML = activeFilters.map((f, i) => {
                    let displayText;
                    if (f.operator === 'between') {
                        displayText = `${variableLabels[f.variable] || f.variable} ${f.value} - ${f.value2}`;
                    } else if (f.displayOp) {
                        displayText = `${variableLabels[f.variable] || f.variable} ${f.displayOp}`;
                    } else {
                        displayText = `${variableLabels[f.variable] || f.variable} ${f.operator} ${f.value}`;
                    }
                    return `<span class="qb-filter-tag">
                        ${displayText}
                        <button class="remove" onclick="removeFilter(${i})">&times;</button>
                    </span>`;
                }).join('');
            }
        }

        function evaluateFilter(participant, filter) {
            const val = participant[filter.variable];
            if (val === null || val === undefined) return false;

            switch (filter.operator) {
                case '>': return val > filter.value;
                case '>=': return val >= filter.value;
                case '<': return val < filter.value;
                case '<=': return val <= filter.value;
                case '=': return val === filter.value;
                case 'between': return val >= filter.value && val <= filter.value2;
                case 'top%': return val >= filter.threshold;
                case 'bottom%': return val <= filter.threshold;
                default: return false;
            }
        }

        // Natural Language Query using AI
        async function runNLQuery() {
            const input = document.getElementById('qbNLQuery');
            const responseDiv = document.getElementById('qbNLResponse');
            const askBtn = document.querySelector('.qb-btn-ai');
            const query = input.value.trim();

            if (!query) {
                alert('Please enter a question');
                return;
            }

            // Disable button and show loading state
            askBtn.disabled = true;
            askBtn.innerHTML = '<span class="spinner" style="width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.8s linear infinite;"></span> Thinking...';
            askBtn.style.opacity = '0.7';

            responseDiv.style.display = 'block';

            // Load data if not already loaded
            if (!participantData) {
                responseDiv.innerHTML = '<em>Loading participant data...</em>';
                try {
                    const url = 'https://raw.githubusercontent.com/Shmron/PRECISE/main/participant_data_expanded.json?v=' + Date.now();
                    const dataResponse = await fetch(url);
                    const json = await dataResponse.json();
                    participantData = json.data;
                    console.log('NL Query: Loaded', participantData.length, 'participants');
                } catch (err) {
                    responseDiv.innerHTML = '<span style="color: var(--coral);">Failed to load participant data. Please try again.</span>';
                    return;
                }
            }

            responseDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div class="shmron-thinking" style="display: flex; gap: 4px;">
                        <span style="width: 8px; height: 8px; background: var(--teal-deep); border-radius: 50%; animation: bounce 1.4s ease-in-out infinite;"></span>
                        <span style="width: 8px; height: 8px; background: var(--teal-deep); border-radius: 50%; animation: bounce 1.4s ease-in-out 0.2s infinite;"></span>
                        <span style="width: 8px; height: 8px; background: var(--teal-deep); border-radius: 50%; animation: bounce 1.4s ease-in-out 0.4s infinite;"></span>
                    </div>
                    <span style="color: var(--teal-deep); font-weight: 500;">Shmron is analyzing your query...</span>
                </div>
                <style>
                    @keyframes bounce {
                        0%, 80%, 100% { transform: translateY(0); }
                        40% { transform: translateY(-6px); }
                    }
                </style>
            `;

            try {
                // Use the chatbot's API key and send the query
                const apiKey = ChatBot.apiKey;

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2048,
                        system: `You are a query assistant for a participant database. When given a natural language query, analyze it and execute appropriate data queries.

Available variables:
- Air Quality: pm25, pm25_p95, pm25_max, pm25_d15 (WHO), pm25_d25, pm25_d35, pm25_d50, pm25_d100, pm25_fire, pm25_nonfire, no2, o3, co, so2, aod, aod_dust, aod_bc (black carbon)
- Temperature: temp, temp_max, temp_min, temp_p95, temp_diurnal, temp_d28, temp_d30, temp_d32, temp_d35
- Heat Stress: wetbulb, wetbulb_max, wb_d20, wb_d25, wb_d28, lst, extreme_hot_days, heatwave_days
- Weather: humidity, hum_d80, hum_d90, precip, rain_d1, rain_d5, rain_d10
- Environment: ndvi, elevation
- Access: walk_dist, walk_time, drive_dist, drive_time, pt_dist, pt_time, dist_hwy, dist_road, road_dens, road_qual
- Isolation: walk_iso_rd, walk_iso_hwy, drive_iso_rd, drive_iso_hwy, isolation
- Socioeconomic: rwi, viirs, ppi
- Soil: soil_ca, soil_n, soil_p, soil_k
- Demographics: age, n (exposure days)

Countries: Ken (Kenya), Moz (Mozambique), Gam (The Gambia)
Settlements: Urban, Rural, Peri-Urban

Always use the tools to answer data questions. Be concise in your response.`,
                        messages: [{ role: 'user', content: query }],
                        tools: ChatBot.tools
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                let data = await response.json();
                let finalText = '';
                let iterations = 0;
                const maxIterations = 5;
                let messages = [{ role: 'user', content: query }];

                // Handle tool use loop
                while (iterations < maxIterations) {
                    iterations++;
                    const toolUseBlocks = data.content.filter(c => c.type === 'tool_use');
                    const textBlocks = data.content.filter(c => c.type === 'text');

                    if (textBlocks.length > 0) {
                        finalText = textBlocks[0].text;
                    }

                    if (toolUseBlocks.length === 0) break;

                    // Execute tools
                    const toolResults = ChatBot.executeTools(toolUseBlocks);
                    messages.push({ role: 'assistant', content: data.content });
                    messages.push({ role: 'user', content: toolResults });

                    // Get next response
                    const nextResponse = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 2048,
                            messages: messages,
                            tools: ChatBot.tools
                        })
                    });

                    data = await nextResponse.json();
                }

                // Format and display response
                responseDiv.innerHTML = ChatBot.formatMessage(finalText || 'Query completed. Check the results below.');

            } catch (error) {
                responseDiv.innerHTML = `<span style="color: var(--coral);">Error: ${error.message}</span>`;
                console.error('NL Query error:', error);
            } finally {
                // Restore button state
                const askBtn = document.querySelector('.qb-btn-ai');
                askBtn.disabled = false;
                askBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg> Ask';
                askBtn.style.opacity = '1';
            }
        }

        // Allow Enter key for NL query
        document.addEventListener('DOMContentLoaded', function() {
            const nlInput = document.getElementById('qbNLQuery');
            if (nlInput) {
                nlInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        runNLQuery();
                    }
                });
            }
        });

        function runQuery() {
            if (!participantData) return;

            // Auto-add any pending filter in the input field (only for simple operators)
            const pendingValue = document.getElementById('qbValue').value;
            const pendingOp = document.getElementById('qbOperator').value;
            if (pendingValue && !isNaN(parseFloat(pendingValue)) && !['between', 'top%', 'bottom%'].includes(pendingOp)) {
                const variable = document.getElementById('qbVariable').value;
                activeFilters.push({ variable, operator: pendingOp, value: parseFloat(pendingValue) });
                renderFilters();
                document.getElementById('qbValue').value = '';
            }

            const country = document.getElementById('qbCountry').value;
            const settlement = document.getElementById('qbSettlement').value;
            const climate = document.getElementById('qbClimate').value;

            // Debug: Show active filters
            console.log('Running query with filters:', activeFilters);
            console.log('Base filters - Country:', country, 'Settlement:', settlement, 'Climate:', climate);

            filteredData = participantData.filter(p => {
                // Base filters
                if (country !== 'all' && p.c !== country) return false;
                if (settlement !== 'all' && p.set !== settlement) return false;
                if (climate !== 'all' && p.clim !== climate) return false;

                // Custom filters
                for (const filter of activeFilters) {
                    if (!evaluateFilter(p, filter)) return false;
                }
                return true;
            });

            console.log('Results:', filteredData.length, 'participants');
            displayResults();
        }

        function displayResults() {
            const total = filteredData.length;
            const kenya = filteredData.filter(p => p.c === 'Ken').length;
            const moz = filteredData.filter(p => p.c === 'Moz').length;
            const gam = filteredData.filter(p => p.c === 'Gam').length;

            document.getElementById('resultCount').textContent = total.toLocaleString();
            document.getElementById('resultPercent').textContent = ((total / 6687) * 100).toFixed(1) + '%';

            document.getElementById('resultKenya').textContent = kenya.toLocaleString();
            document.getElementById('resultMoz').textContent = moz.toLocaleString();
            document.getElementById('resultGam').textContent = gam.toLocaleString();

            document.getElementById('resultKenyaPct').textContent = ((kenya / countryTotals.Ken) * 100).toFixed(1) + '% of Kenya';
            document.getElementById('resultMozPct').textContent = ((moz / countryTotals.Moz) * 100).toFixed(1) + '% of Mozambique';
            document.getElementById('resultGamPct').textContent = ((gam / countryTotals.Gam) * 100).toFixed(1) + '% of Gambia';

            // Calculate summary stats for matching participants
            if (filteredData.length > 0) {
                const stats = calculateStats(filteredData);
                document.getElementById('qbStats').innerHTML = `
                    <div class="qb-stat"><div class="qb-stat-label">Avg PM2.5</div><div class="qb-stat-value">${stats.pm25.toFixed(1)}</div></div>
                    <div class="qb-stat"><div class="qb-stat-label">Avg Temp</div><div class="qb-stat-value">${stats.temp.toFixed(1)}C</div></div>
                    <div class="qb-stat"><div class="qb-stat-label">Avg Age</div><div class="qb-stat-value">${stats.age.toFixed(0)}</div></div>
                    <div class="qb-stat"><div class="qb-stat-label">Avg Exposure Days</div><div class="qb-stat-value">${stats.n.toFixed(0)}</div></div>
                    <div class="qb-stat"><div class="qb-stat-label">Avg Walk Time</div><div class="qb-stat-value">${stats.walk_time.toFixed(0)} min</div></div>
                `;
            } else {
                document.getElementById('qbStats').innerHTML = '<div class="qb-stat"><div class="qb-stat-label">No matching participants</div></div>';
            }

            document.getElementById('qbResults').classList.add('active');
        }

        function calculateStats(data) {
            const sum = (arr, key) => {
                const valid = arr.filter(p => p[key] !== null && p[key] !== undefined);
                return valid.length ? valid.reduce((s, p) => s + p[key], 0) / valid.length : 0;
            };
            return {
                pm25: sum(data, 'pm25'),
                temp: sum(data, 'temp'),
                age: sum(data, 'age'),
                n: sum(data, 'n'),
                walk_time: sum(data, 'walk_time')
            };
        }

        function exportResults() {
            if (!filteredData || filteredData.length === 0) {
                alert('No results to export. Run a query first.');
                return;
            }

            const headers = ['id', 'country', 'village', 'settlement', 'age', 'exposure_days', 'pm25_mean', 'pm25_p95', 'temp_mean', 'wetbulb', 'walk_time'];
            const rows = filteredData.map(p => [
                p.id, p.c, p.v || '', p.set || '', p.age || '', p.n || '',
                p.pm25 || '', p.pm25_p95 || '', p.temp || '', p.wetbulb || '', p.walk_time || ''
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `precise_query_results_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Close modal on overlay click
        document.addEventListener('click', function(e) {
            if (e.target.id === 'explorerOverlay') {
                closeDataExplorer();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const firstCategory = document.querySelector('.category-header');
                if (firstCategory) {
                    toggleCategory(firstCategory);
                }
            }, 400);
        });

        const observerOptions = { threshold: 0.1, rootMargin: '0px 0px -50px 0px' };
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animationPlayState = 'running';
                }
            });
        }, observerOptions);

        document.querySelectorAll('.category-section').forEach(section => {
            section.style.animationPlayState = 'paused';
            observer.observe(section);
        });

        // ============================================
        // EMAIL INQUIRY (Obfuscated to prevent spam)
        // ============================================
        function sendInquiry() {
            // Email addresses encoded to prevent harvesting by bots
            var p2 = ['rutendo', 'sibanda'].join('.');
            var p1 = ['tatenda', 'makanga'].join('.');
            var p3 = ['zororo', 'chinwadzimba'].join('.');
            var d1 = ['ceshhar', 'org'].join('.');
            var d2 = ['ceshhar', 'org'].join('.');
            var d3 = ['ceshhar', 'org'].join('.');
            var to = p1 + '@' + d1;
            var cc = p2 + '@' + d2 + ',' + p3 + '@' + d3;
            var subject = encodeURIComponent('Inquiry: PRECISE Network Environmental & Social Determinants Catalogue');
            var body = encodeURIComponent('Dear PRECISE Network Team,\n\nI am writing to inquire about the Environmental & Social Determinants of Maternal Health catalogue.\n\n[Please describe your inquiry here]\n\nBest regards,\n[Your name]');
            window.location.href = 'mail' + 'to:' + to + '?cc=' + cc + '&subject=' + subject + '&body=' + body;
        }

        // ============================================
        // AI CHATBOT - Powered by Claude (Anthropic) with Live Data Queries
        // ===================================================================

        const ChatBot = {
            // Key components (obfuscated)
            _k: ['c2stYW50LWFwaTAzLWZGVUtxNUhq', 'MjVCUW5NOTF2QnFCaUQ4Q3cxYVMy', 'SThHTjRzSUZqUHI2ZGVWSW9qWl95', 'cVByNV9XUnBMREFYOGtJN1dQTzFS', 'OEFwZlVhbS04cFBvTDh3LXlsbUpD', 'UUFB'],
            get apiKey() { return atob(this._k.join('')); },
            conversationHistory: [],

            // Tool definitions for Claude
            tools: [
                {
                    name: "query_participants",
                    description: "Query the participant database to find participants matching specific criteria. Returns count and breakdown by country. Use this when users ask about specific thresholds, comparisons, or want to explore the data.",
                    input_schema: {
                        type: "object",
                        properties: {
                            filters: {
                                type: "array",
                                description: "Array of filter conditions to apply",
                                items: {
                                    type: "object",
                                    properties: {
                                        variable: {
                                            type: "string",
                                            enum: ["pm25", "pm25_p95", "pm25_max", "pm25_d15", "pm25_d25", "pm25_d35", "pm25_d50", "pm25_d100", "pm25_fire", "pm25_nonfire", "no2", "o3", "co", "so2", "aod", "aod_dust", "aod_bc", "temp", "temp_max", "temp_min", "temp_p95", "temp_diurnal", "temp_d28", "temp_d30", "temp_d32", "temp_d35", "wetbulb", "wetbulb_max", "wb_d20", "wb_d25", "wb_d28", "lst", "extreme_hot_days", "heatwave_days", "temp_deviation", "humidity", "hum_d80", "hum_d90", "precip", "rain_d1", "rain_d5", "rain_d10", "ndvi", "elevation", "walk_dist", "walk_time", "drive_dist", "drive_time", "pt_dist", "pt_time", "dist_hwy", "dist_road", "road_dens", "road_qual", "walk_iso_rd", "walk_iso_hwy", "drive_iso_rd", "drive_iso_hwy", "isolation", "rwi", "viirs", "ppi", "soil_ca", "soil_n", "soil_p", "soil_k", "age", "n"],
                                            description: "Variable to filter on"
                                        },
                                        operator: {
                                            type: "string",
                                            enum: [">", ">=", "<", "<=", "=", "between"],
                                            description: "Comparison operator"
                                        },
                                        value: {
                                            type: "number",
                                            description: "Value to compare against (for between, use min value)"
                                        },
                                        value2: {
                                            type: "number",
                                            description: "Second value for 'between' operator (max value)"
                                        }
                                    },
                                    required: ["variable", "operator", "value"]
                                }
                            },
                            country: {
                                type: "string",
                                enum: ["all", "Ken", "Moz", "Gam"],
                                description: "Filter by country (Ken=Kenya, Moz=Mozambique, Gam=The Gambia)"
                            },
                            settlement: {
                                type: "string",
                                enum: ["all", "Urban", "Rural", "Peri-Urban"],
                                description: "Filter by settlement type"
                            },
                            include_stats: {
                                type: "boolean",
                                description: "Whether to include descriptive statistics for the filtered results"
                            }
                        },
                        required: ["filters"]
                    }
                },
                {
                    name: "get_statistics",
                    description: "Get descriptive statistics (mean, median, percentiles) for a variable, optionally grouped by country or settlement type.",
                    input_schema: {
                        type: "object",
                        properties: {
                            variable: {
                                type: "string",
                                enum: ["pm25", "pm25_p95", "pm25_max", "pm25_d15", "pm25_d25", "pm25_d35", "pm25_d50", "pm25_d100", "pm25_fire", "pm25_nonfire", "no2", "o3", "co", "so2", "aod", "aod_dust", "aod_bc", "temp", "temp_max", "temp_min", "temp_p95", "temp_diurnal", "temp_d28", "temp_d30", "temp_d32", "temp_d35", "wetbulb", "wetbulb_max", "wb_d20", "wb_d25", "wb_d28", "lst", "extreme_hot_days", "heatwave_days", "temp_deviation", "humidity", "hum_d80", "hum_d90", "precip", "rain_d1", "rain_d5", "rain_d10", "ndvi", "elevation", "walk_dist", "walk_time", "drive_dist", "drive_time", "pt_dist", "pt_time", "dist_hwy", "dist_road", "road_dens", "road_qual", "walk_iso_rd", "walk_iso_hwy", "drive_iso_rd", "drive_iso_hwy", "isolation", "rwi", "viirs", "ppi", "soil_ca", "soil_n", "soil_p", "soil_k", "age", "n"],
                                description: "Variable to analyze"
                            },
                            group_by: {
                                type: "string",
                                enum: ["none", "country", "settlement"],
                                description: "How to group the statistics"
                            },
                            country: {
                                type: "string",
                                enum: ["all", "Ken", "Moz", "Gam"],
                                description: "Optionally filter to specific country first"
                            }
                        },
                        required: ["variable"]
                    }
                },
                {
                    name: "compare_groups",
                    description: "Compare a variable between two groups (e.g., Urban vs Rural, or Kenya vs Mozambique).",
                    input_schema: {
                        type: "object",
                        properties: {
                            variable: {
                                type: "string",
                                enum: ["pm25", "pm25_p95", "pm25_max", "pm25_d15", "pm25_d25", "pm25_d35", "pm25_d50", "pm25_d100", "pm25_fire", "pm25_nonfire", "no2", "o3", "co", "so2", "aod", "aod_dust", "aod_bc", "temp", "temp_max", "temp_min", "temp_p95", "temp_diurnal", "temp_d28", "temp_d30", "temp_d32", "temp_d35", "wetbulb", "wetbulb_max", "wb_d20", "wb_d25", "wb_d28", "lst", "extreme_hot_days", "heatwave_days", "temp_deviation", "humidity", "hum_d80", "hum_d90", "precip", "rain_d1", "rain_d5", "rain_d10", "ndvi", "elevation", "walk_dist", "walk_time", "drive_dist", "drive_time", "pt_dist", "pt_time", "dist_hwy", "dist_road", "road_dens", "road_qual", "walk_iso_rd", "walk_iso_hwy", "drive_iso_rd", "drive_iso_hwy", "isolation", "rwi", "viirs", "ppi", "soil_ca", "soil_n", "soil_p", "soil_k", "age", "n"],
                                description: "Variable to compare"
                            },
                            compare_by: {
                                type: "string",
                                enum: ["country", "settlement"],
                                description: "Dimension to compare across"
                            }
                        },
                        required: ["variable", "compare_by"]
                    }
                },
                {
                    name: "get_percentile_threshold",
                    description: "Find the value at a specific percentile for a variable, or find participants above/below a percentile.",
                    input_schema: {
                        type: "object",
                        properties: {
                            variable: {
                                type: "string",
                                enum: ["pm25", "pm25_p95", "pm25_max", "pm25_d15", "pm25_d25", "pm25_d35", "pm25_d50", "pm25_d100", "pm25_fire", "pm25_nonfire", "no2", "o3", "co", "so2", "aod", "aod_dust", "aod_bc", "temp", "temp_max", "temp_min", "temp_p95", "temp_diurnal", "temp_d28", "temp_d30", "temp_d32", "temp_d35", "wetbulb", "wetbulb_max", "wb_d20", "wb_d25", "wb_d28", "lst", "extreme_hot_days", "heatwave_days", "temp_deviation", "humidity", "hum_d80", "hum_d90", "precip", "rain_d1", "rain_d5", "rain_d10", "ndvi", "elevation", "walk_dist", "walk_time", "drive_dist", "drive_time", "pt_dist", "pt_time", "dist_hwy", "dist_road", "road_dens", "road_qual", "walk_iso_rd", "walk_iso_hwy", "drive_iso_rd", "drive_iso_hwy", "isolation", "rwi", "viirs", "ppi", "soil_ca", "soil_n", "soil_p", "soil_k", "age", "n"],
                                description: "Variable to analyze"
                            },
                            percentile: {
                                type: "number",
                                description: "Percentile to find (0-100, e.g., 75 for 75th percentile)"
                            },
                            country: {
                                type: "string",
                                enum: ["all", "Ken", "Moz", "Gam"],
                                description: "Optionally filter to specific country"
                            },
                            return_participants: {
                                type: "string",
                                enum: ["none", "above", "below"],
                                description: "Whether to return count of participants above or below this percentile"
                            }
                        },
                        required: ["variable", "percentile"]
                    }
                },
                {
                    name: "cross_tabulation",
                    description: "Create a cross-tabulation showing counts or statistics across two dimensions.",
                    input_schema: {
                        type: "object",
                        properties: {
                            row_variable: {
                                type: "string",
                                enum: ["country", "settlement", "climate"],
                                description: "Variable for rows"
                            },
                            col_variable: {
                                type: "string",
                                enum: ["country", "settlement", "climate"],
                                description: "Variable for columns"
                            },
                            value_variable: {
                                type: "string",
                                enum: ["count", "pm25", "pm25_p95", "temp", "temp_max", "wetbulb", "humidity", "walk_time", "drive_time", "rwi", "viirs", "age"],
                                description: "What to show in cells (count or mean of a variable)"
                            }
                        },
                        required: ["row_variable", "col_variable", "value_variable"]
                    }
                }
            ],

            // Execute tool calls
            executeTools(toolCalls) {
                const results = [];
                for (const tool of toolCalls) {
                    const input = tool.input;
                    let result;

                    switch (tool.name) {
                        case 'query_participants':
                            result = this.toolQueryParticipants(input);
                            break;
                        case 'get_statistics':
                            result = this.toolGetStatistics(input);
                            break;
                        case 'compare_groups':
                            result = this.toolCompareGroups(input);
                            break;
                        case 'get_percentile_threshold':
                            result = this.toolGetPercentile(input);
                            break;
                        case 'cross_tabulation':
                            result = this.toolCrossTab(input);
                            break;
                        default:
                            result = { error: 'Unknown tool' };
                    }

                    results.push({
                        type: "tool_result",
                        tool_use_id: tool.id,
                        content: JSON.stringify(result)
                    });
                }
                return results;
            },

            // Tool implementations
            toolQueryParticipants(input) {
                if (!participantData) return { error: "Data not loaded. Please open Data Explorer first to load the participant data." };

                const { filters = [], country = 'all', settlement = 'all', include_stats = false } = input;

                const filtered = participantData.filter(p => {
                    // Base filters
                    if (country !== 'all' && p.c !== country) return false;
                    if (settlement !== 'all' && p.set !== settlement) return false;

                    // Custom filters
                    for (const f of filters) {
                        const val = p[f.variable];
                        if (val === null || val === undefined) return false;

                        switch (f.operator) {
                            case '>': if (!(val > f.value)) return false; break;
                            case '>=': if (!(val >= f.value)) return false; break;
                            case '<': if (!(val < f.value)) return false; break;
                            case '<=': if (!(val <= f.value)) return false; break;
                            case '=': if (val !== f.value) return false; break;
                            case 'between': if (!(val >= f.value && val <= f.value2)) return false; break;
                        }
                    }
                    return true;
                });

                const result = {
                    total_matching: filtered.length,
                    total_participants: participantData.length,
                    percentage: ((filtered.length / participantData.length) * 100).toFixed(1) + '%',
                    by_country: {
                        Kenya: { count: filtered.filter(p => p.c === 'Ken').length, of_country: 3194 },
                        Mozambique: { count: filtered.filter(p => p.c === 'Moz').length, of_country: 2053 },
                        Gambia: { count: filtered.filter(p => p.c === 'Gam').length, of_country: 1278 }
                    },
                    by_settlement: {
                        Urban: filtered.filter(p => p.set === 'Urban').length,
                        Rural: filtered.filter(p => p.set === 'Rural').length,
                        'Peri-Urban': filtered.filter(p => p.set === 'Peri-Urban').length
                    }
                };

                // Add percentages
                result.by_country.Kenya.percentage = ((result.by_country.Kenya.count / 3194) * 100).toFixed(1) + '%';
                result.by_country.Mozambique.percentage = ((result.by_country.Mozambique.count / 2053) * 100).toFixed(1) + '%';
                result.by_country.Gambia.percentage = ((result.by_country.Gambia.count / 1278) * 100).toFixed(1) + '%';

                if (include_stats && filters.length > 0) {
                    const mainVar = filters[0].variable;
                    const values = filtered.map(p => p[mainVar]).filter(v => v != null).sort((a,b) => a-b);
                    if (values.length > 0) {
                        result.stats = {
                            variable: mainVar,
                            n: values.length,
                            mean: (values.reduce((a,b) => a+b, 0) / values.length).toFixed(2),
                            median: values[Math.floor(values.length / 2)].toFixed(2),
                            min: values[0].toFixed(2),
                            max: values[values.length - 1].toFixed(2)
                        };
                    }
                }

                return result;
            },

            toolGetStatistics(input) {
                if (!participantData) return { error: "Data not loaded" };

                const { variable, group_by = 'none', country = 'all' } = input;

                let data = country === 'all' ? participantData : participantData.filter(p => p.c === country);

                const calcStats = (arr) => {
                    const values = arr.map(p => p[variable]).filter(v => v != null).sort((a,b) => a-b);
                    if (values.length === 0) return null;
                    const n = values.length;
                    return {
                        n,
                        mean: (values.reduce((a,b) => a+b, 0) / n).toFixed(2),
                        median: values[Math.floor(n / 2)].toFixed(2),
                        q1: values[Math.floor(n * 0.25)].toFixed(2),
                        q3: values[Math.floor(n * 0.75)].toFixed(2),
                        p5: values[Math.floor(n * 0.05)].toFixed(2),
                        p95: values[Math.floor(n * 0.95)].toFixed(2),
                        min: values[0].toFixed(2),
                        max: values[n - 1].toFixed(2)
                    };
                };

                if (group_by === 'none') {
                    return { variable, stats: calcStats(data) };
                } else if (group_by === 'country') {
                    return {
                        variable,
                        by_country: {
                            Kenya: calcStats(data.filter(p => p.c === 'Ken')),
                            Mozambique: calcStats(data.filter(p => p.c === 'Moz')),
                            Gambia: calcStats(data.filter(p => p.c === 'Gam'))
                        }
                    };
                } else if (group_by === 'settlement') {
                    return {
                        variable,
                        by_settlement: {
                            Urban: calcStats(data.filter(p => p.set === 'Urban')),
                            Rural: calcStats(data.filter(p => p.set === 'Rural')),
                            'Peri-Urban': calcStats(data.filter(p => p.set === 'Peri-Urban'))
                        }
                    };
                }
            },

            toolCompareGroups(input) {
                if (!participantData) return { error: "Data not loaded" };

                const { variable, compare_by } = input;
                const result = { variable, comparison: compare_by, groups: {} };

                const calcStats = (arr) => {
                    const values = arr.map(p => p[variable]).filter(v => v != null).sort((a,b) => a-b);
                    if (values.length === 0) return null;
                    const n = values.length;
                    return {
                        n,
                        mean: (values.reduce((a,b) => a+b, 0) / n).toFixed(2),
                        median: values[Math.floor(n / 2)].toFixed(2),
                        q1: values[Math.floor(n * 0.25)].toFixed(2),
                        q3: values[Math.floor(n * 0.75)].toFixed(2)
                    };
                };

                if (compare_by === 'country') {
                    result.groups = {
                        Kenya: calcStats(participantData.filter(p => p.c === 'Ken')),
                        Mozambique: calcStats(participantData.filter(p => p.c === 'Moz')),
                        Gambia: calcStats(participantData.filter(p => p.c === 'Gam'))
                    };
                } else if (compare_by === 'settlement') {
                    result.groups = {
                        Urban: calcStats(participantData.filter(p => p.set === 'Urban')),
                        Rural: calcStats(participantData.filter(p => p.set === 'Rural')),
                        'Peri-Urban': calcStats(participantData.filter(p => p.set === 'Peri-Urban'))
                    };
                }

                return result;
            },

            toolGetPercentile(input) {
                if (!participantData) return { error: "Data not loaded" };

                const { variable, percentile, country = 'all', return_participants = 'none' } = input;

                let data = country === 'all' ? participantData : participantData.filter(p => p.c === country);
                const values = data.map(p => p[variable]).filter(v => v != null).sort((a,b) => a-b);

                if (values.length === 0) return { error: "No data" };

                const idx = Math.floor(values.length * (percentile / 100));
                const threshold = values[Math.min(idx, values.length - 1)];

                const result = {
                    variable,
                    percentile,
                    threshold_value: threshold.toFixed(2),
                    country_filter: country
                };

                if (return_participants === 'above') {
                    const above = data.filter(p => p[variable] != null && p[variable] > threshold);
                    result.participants_above = {
                        count: above.length,
                        percentage: ((above.length / data.length) * 100).toFixed(1) + '%',
                        by_country: {
                            Kenya: above.filter(p => p.c === 'Ken').length,
                            Mozambique: above.filter(p => p.c === 'Moz').length,
                            Gambia: above.filter(p => p.c === 'Gam').length
                        }
                    };
                } else if (return_participants === 'below') {
                    const below = data.filter(p => p[variable] != null && p[variable] <= threshold);
                    result.participants_below = {
                        count: below.length,
                        percentage: ((below.length / data.length) * 100).toFixed(1) + '%',
                        by_country: {
                            Kenya: below.filter(p => p.c === 'Ken').length,
                            Mozambique: below.filter(p => p.c === 'Moz').length,
                            Gambia: below.filter(p => p.c === 'Gam').length
                        }
                    };
                }

                return result;
            },

            toolCrossTab(input) {
                if (!participantData) return { error: "Data not loaded" };

                const { row_variable, col_variable, value_variable } = input;

                const getGroup = (p, v) => {
                    if (v === 'country') return p.c === 'Ken' ? 'Kenya' : p.c === 'Moz' ? 'Mozambique' : 'Gambia';
                    if (v === 'settlement') return p.set;
                    if (v === 'climate') return p.clim;
                    return 'Unknown';
                };

                const rows = [...new Set(participantData.map(p => getGroup(p, row_variable)))];
                const cols = [...new Set(participantData.map(p => getGroup(p, col_variable)))];

                const table = {};
                for (const row of rows) {
                    table[row] = {};
                    for (const col of cols) {
                        const subset = participantData.filter(p =>
                            getGroup(p, row_variable) === row && getGroup(p, col_variable) === col
                        );

                        if (value_variable === 'count') {
                            table[row][col] = subset.length;
                        } else {
                            const values = subset.map(p => p[value_variable]).filter(v => v != null);
                            table[row][col] = values.length > 0
                                ? (values.reduce((a,b) => a+b, 0) / values.length).toFixed(2)
                                : 'N/A';
                        }
                    }
                }

                return { row_variable, col_variable, value_variable, table };
            },

            systemPrompt: `You are Shmron, an expert research assistant for the PRECISE Network study on Environmental & Social Determinants of Maternal Health. This study analyzed data from 6,687 pregnant women across 525 communities in Kenya (n=3,194 participants, 370 communities), Mozambique (n=2,053 participants, 74 communities), and The Gambia (n=1,278 participants, 81 communities).

=== COMPLETE CATALOGUE DATA (Values shown as Median [Q1, Q3] P95: 95th percentile) ===

**CATEGORY 1: AIR POLLUTION AND RELATED PROXIES**
- NDVI (-1 to 1): Kenya 0.02 [-0.01, 0.21] P95:0.40 | Mozambique 0.14 [-0.01, 0.39] P95:0.57 | Gambia 0.13 [0.09, 0.17] P95:0.30 | All 0.12 [0.01, 0.21] P95:0.46
- Distance to Highways (km): Kenya 1.8 [0.5, 3.1] P95:5.4 | Mozambique 1.0 [0.4, 7.2] P95:8.1 | Gambia 0.6 [0.6, 4.7] P95:8.4 | All 1.3 [0.5, 3.7] P95:8.1
- Distance to Major Roads (km): Kenya 1.3 [0.5, 2.7] P95:4.9 | Mozambique 1.0 [0.4, 1.2] P95:4.9 | Gambia 0.5 [0.5, 2.1] P95:8.1 | All 1.0 [0.4, 2.7] P95:6.9
- Road Network Density (km): Kenya 4.0 [2.1, 17.5] P95:20.9 | Mozambique 9.9 [5.2, 11.7] P95:11.7 | Gambia 12.6 [7.2, 18.0] P95:18.0 | All 9.0 [2.7, 13.1] P95:19.1
- Elevation (m): Kenya 188.8 [169.2, 192.2] P95:199.6 | Mozambique 19.0 [18.6, 33.1] P95:44.6 | Gambia 26.6 [15.3, 26.6] P95:35.6 | All 35.4 [19.9, 182.1] P95:199.6
- CO (g/m): Kenya 0.8 [0.7, 0.8] P95:1.0 | Mozambique 0.7 [0.7, 0.9] P95:1.1 | Gambia 1.0 [0.9, 1.0] P95:1.2 | All 0.8 [0.7, 0.9] P95:1.1
- NO2 (mol/m): Kenya 0.02 [0.02, 0.03] P95:0.03 | Mozambique 0.03 [0.03, 0.04] P95:0.07 | Gambia 0.05 [0.04, 0.05] P95:0.07 | All 0.03 [0.02, 0.04] P95:0.06
- O3 (DU): Kenya 265.2 [259.6, 270.0] P95:276.3 | Mozambique 272.1 [265.4, 283.4] P95:297.2 | Gambia 268.9 [259.6, 276.5] P95:287.0 | All 267.6 [261.2, 274.0] P95:290.0
- SO2 (DU): Kenya 0.0 [0.0, 0.0] P95:0.0 | Mozambique 0.1 [0.0, 0.1] P95:0.3 | Gambia 0.1 [0.1, 0.2] P95:0.3 | All 0.0 [0.0, 0.1] P95:0.2
- PM2.5 (g/m): Kenya 12.9 [10.2, 16.8] P95:26.9 | Mozambique 13.2 [8.7, 19.9] P95:32.9 | Gambia 47.8 [30.6, 73.5] P95:140.9 | All 14.9 [10.5, 24.4] P95:73.5
- Fire Smoke PM2.5 (g/m): Kenya 0.0 [0.0, 0.1] P95:0.6 | Mozambique 0.1 [0.0, 0.4] P95:2.0 | Gambia 0.1 [0.0, 0.6] P95:1.9 | All 0.1 [0.0, 0.2] P95:1.5
- Non-Fire Smoke PM2.5 (g/m): Kenya 5.2 [3.7, 8.0] P95:16.6 | Mozambique 4.2 [3.0, 6.2] P95:12.7 | Gambia 42.2 [15.4, 67.9] P95:115.5 | All 5.3 [3.6, 11.1] P95:67.1
- Total AOD: Kenya 0.2 [0.1, 0.2] P95:0.4 | Mozambique 0.1 [0.1, 0.1] P95:0.4 | Gambia 0.3 [0.2, 0.5] P95:0.8 | All 0.2 [0.1, 0.3] P95:0.5
- Dust AOD: Kenya 0.0 [0.0, 0.0] P95:0.1 | Mozambique 0.0 [0.0, 0.0] P95:0.0 | Gambia 0.2 [0.1, 0.3] P95:0.5 | All 0.0 [0.0, 0.0] P95:0.3
- Black Carbon AOD: Kenya 0.0 [0.0, 0.0] P95:0.0 | Mozambique 0.0 [0.0, 0.0] P95:0.0 | Gambia 0.0 [0.0, 0.0] P95:0.0 | All 0.0 [0.0, 0.0] P95:0.0

**CATEGORY 2: SPATIAL ACCESS TO CARE**
- Road Quality Index (0-1): Kenya 0.5 [0.5, 0.6] P95:0.6 | Mozambique 0.4 [0.4, 0.5] P95:0.5 | Gambia 0.4 [0.4, 0.5] P95:0.7 | All 0.5 [0.4, 0.5] P95:0.6
- Walking Distance to Facility (km): Kenya 3.0 [1.5, 4.4] P95:28.7 | Mozambique 3.6 [3.3, 5.6] P95:23.3 | Gambia 1.6 [1.3, 6.7] P95:11.6 | All 3.1 [1.5, 5.1] P95:22.2
- Walking Time to Facility (min): Kenya 35.7 [18.3, 52.9] P95:344.3 | Mozambique 43.7 [39.6, 67.3] P95:280.1 | Gambia 19.2 [15.5, 80.1] P95:139.4 | All 37.7 [18.3, 61.2] P95:266.1
- Driving Distance to Facility (km): Kenya 3.0 [1.5, 4.4] P95:28.7 | Mozambique 3.6 [3.3, 5.6] P95:23.3 | Gambia 1.6 [1.3, 6.7] P95:11.6 | All 3.1 [1.5, 5.1] P95:22.2
- Driving Time to Facility (min): Kenya 4.6 [3.6, 6.0] P95:28.2 | Mozambique 5.8 [5.8, 9.9] P95:43.5 | Gambia 3.7 [2.1, 7.9] P95:14.2 | All 5.3 [3.6, 6.7] P95:31.7
- Public Transport Distance (km): Kenya 5.4 [2.2, 9.7] P95:30.8 | Mozambique 3.7 [3.1, 4.2] P95:23.3 | Gambia 3.2 [1.5, 10.3] P95:22.5 | All 3.7 [1.8, 8.0] P95:23.3
- Public Transport Time (min): Kenya 39.2 [24.8, 63.9] P95:121.2 | Mozambique 30.4 [26.6, 38.5] P95:124.4 | Gambia 29.1 [23.3, 54.1] P95:146.9 | All 33.7 [24.8, 58.0] P95:126.9

**CATEGORY 3: PHYSICAL ISOLATION**
- Walking Distance to Major Roads (km): Kenya 1.9 [0.9, 4.4] P95:10.1 | Mozambique 1.3 [0.6, 1.9] P95:15.2 | Gambia 0.7 [0.6, 2.6] P95:10.4 | All 1.3 [0.7, 3.9] P95:10.1
- Walking Distance to Highways (km): Kenya 2.9 [0.9, 4.9] P95:10.6 | Mozambique 1.3 [0.6, 15.1] P95:16.3 | Gambia 0.7 [0.7, 5.1] P95:10.8 | All 1.9 [0.7, 5.9] P95:15.5

**CATEGORY 4: HEAT EXPOSURE AND WEATHER**
- Wet Bulb Temperature (C) [Tier 1]: Kenya 21.4 [19.8, 22.8] P95:24.3 | Mozambique 17.1 [14.3, 20.1] P95:22.9 | Gambia 14.7 [8.6, 23.0] P95:24.6 | All 20.1 [16.4, 22.3] P95:24.3
- Ambient Temperature (C) [Tier 2]: Kenya 27.3 [25.7, 28.3] P95:29.3 | Mozambique 24.1 [21.5, 26.5] P95:29.1 | Gambia 27.6 [26.2, 28.7] P95:30.3 | All 26.7 [24.9, 28.2] P95:29.5
- Diurnal Temperature (C) [Tier 2]: Kenya 6.7 [5.6, 8.0] P95:10.3 | Mozambique 8.9 [6.4, 11.8] P95:14.9 | Gambia 12.5 [8.2, 14.5] P95:16.6 | All 7.7 [6.1, 10.8] P95:15.2
- Land Surface Temperature (C) [Tier 3]: Kenya 28.3 [28.3, 28.9] P95:29.1 | Mozambique 29.2 [29.2, 30.1] P95:30.3 | Gambia 26.6 [25.9, 26.6] P95:26.8 | All 28.7 [28.3, 29.2] P95:30.3

**CATEGORY 5: PRECIPITATION**
- Precipitation (mm/day): Kenya 0.0 [0.0, 0.0] P95:11.8 | Mozambique 0.0 [0.0, 0.7] P95:12.6 | Gambia 0.0 [0.0, 0.7] P95:15.9 | All 0.0 [0.0, 0.4] P95:13.0

**CATEGORY 6: RELATIVE HUMIDITY**
- Relative Humidity (%): Kenya 72.4 [68.6, 76.6] P95:82.7 | Mozambique 69.8 [63.7, 75.0] P95:82.3 | Gambia 55.6 [38.8, 77.7] P95:87.2 | All 70.9 [65.3, 76.2] P95:84.2

**CATEGORY 7: SOIL MICRO-NUTRIENTS**
- Calcium (ppm): Kenya 62.5 [61.7, 63.0] P95:64.5 | Mozambique 60.1 [60.1, 67.8] P95:68.6 | Gambia 62.7 [61.5, 62.7] P95:64.7 | All 62.5 [61.6, 63.3] P95:68.6
- Nitrogen (g/kg): Kenya 57.7 [56.2, 72.3] P95:80.5 | Mozambique 53.8 [52.9, 62.6] P95:78.5 | Gambia 49.1 [48.3, 52.8] P95:58.2 | All 56.2 [52.9, 63.5] P95:78.5
- Phosphorus (ppm): Kenya 25.1 [23.6, 25.3] P95:25.8 | Mozambique 24.3 [24.1, 24.6] P95:25.4 | Gambia 23.6 [23.6, 23.8] P95:24.9 | All 24.2 [23.6, 25.1] P95:25.5
- Potassium (ppm): Kenya 46.2 [45.8, 46.4] P95:47.2 | Mozambique 45.3 [44.8, 47.8] P95:49.4 | Gambia 41.8 [41.2, 42.2] P95:42.2 | All 45.8 [44.8, 46.4] P95:48.3

**CATEGORY 8: URBAN FORM**
- Settlement Classification: Kenya (Peri-Urban 26.1%, Rural 8.0%, Urban 65.8%) | Mozambique (Peri-Urban 7.1%, Rural 20.5%, Urban 72.3%) | Gambia (Peri-Urban 0.2%, Rural 60.3%, Urban 39.5%) | All (Peri-Urban 14.7%, Rural 21.9%, Urban 63.4%)

**CATEGORY 9: IPCC CLIMATE ZONE**
- Tropical Dry: Kenya 97.2% | Mozambique 99.9% | Gambia 98.6% | All 98.4%
- Tropical Moist: Kenya 1.0% | Mozambique 0.0% | Gambia 1.4% | All 0.8%
- Tropical Montane: Kenya 0.4% | All 0.2%
- Warm Temperate Dry: Kenya 1.2% | All 0.6%

**CATEGORY 10: WEALTH AND DEVELOPMENT INDICATORS**
- VIIRS Night Lights (nW/cm/sr): Kenya 3.0 [1.1, 5.6] P95:6.7 | Mozambique 2.9 [0.6, 6.6] P95:8.7 | Gambia 0.5 [0.0, 1.6] P95:1.7 | All 1.9 [0.8, 5.5] P95:8.3
- Relative Wealth Index: Kenya 0.6 [0.2, 0.8] P95:1.0 | Mozambique 0.3 [0.2, 0.4] P95:0.9 | Gambia -0.1 [-0.4, 0.5] P95:0.5 | All 0.3 [0.1, 0.6] P95:1.0

**CATEGORY 11: SOCIO-GEOGRAPHIC CHARACTERISTICS (%)**
- Social Inclusion: Kenya 3.8% | Mozambique 6.9% | Gambia 9.3% | All 5.9%
- Community Help: Kenya 75.0% | Mozambique 51.3% | Gambia 49.6% | All 62.7%
- General Financial Autonomy: Kenya 68.8% | Mozambique 50.6% | Gambia 72.9% | All 64.0%
- Pregnancy Financial Autonomy: Kenya 62.5% | Mozambique 54.2% | Gambia 81.1% | All 63.7%
- Partner Availability: Kenya 80.3% | Mozambique 63.1% | Gambia 66.3% | All 72.1%
- Emotional Support: Kenya 39.3% | Mozambique 23.8% | Gambia 28.2% | All 32.5%
- Transport Support: Kenya 25.1% | Mozambique 19.9% | Gambia 17.5% | All 21.9%
- Financial Support: Kenya 5.4% | Mozambique 7.1% | Gambia 0.4% | All 4.9%

=== PARTICIPANT-LEVEL EXPOSURE STATISTICS (EXACT COUNTS) ===
These are exact counts of individual participants exceeding key thresholds:

**AMBIENT TEMPERATURE (Mean during pregnancy):**
- Temp > 20C: 6,657 total (99.6%) | Kenya 3,164 | Mozambique 2,053 | Gambia 1,278
- Temp > 22C: 6,640 total (99.3%) | Kenya 3,150 | Mozambique 2,050 | Gambia 1,278
- Temp > 25C: 4,583 total (68.5%) | Kenya 3,130 | Mozambique 14 | Gambia 1,277
- Temp > 28C: 68 total (1.0%) | Kenya 1 | Mozambique 0 | Gambia 61
- Temp > 30C: 0 total | No participants had mean temp above 30C

**WET BULB TEMPERATURE (Heat stress indicator):**
- Wet Bulb > 20C: 2,305 total (34.5%) | Kenya 2,189 | Mozambique 1 | Gambia 8
- Wet Bulb > 22C: 1,443 total (21.6%) | Kenya 1,388 | Mozambique 0 | Gambia 3
- Wet Bulb > 25C: 0 total | No participants exceeded dangerous wet bulb threshold

**PM2.5 AIR POLLUTION (Mean values during pregnancy):**
- PM2.5 > 10 ug/m3: 6,683 total (99.9%) | Kenya 3,191 | Mozambique 2,052 | Gambia 1,278
- PM2.5 > 15 ug/m3 (WHO guideline): 2,814 total (42.1%) | Kenya 234 | Mozambique 1,248 | Gambia 1,278
- PM2.5 > 25 ug/m3 (Unhealthy): 1,376 total (20.6%) | Kenya 51 | Mozambique 0 | Gambia 1,278
- PM2.5 > 35 ug/m3: 1,351 total (20.2%) | Kenya 27 | Mozambique 0 | Gambia 1,277
- PM2.5 > 50 ug/m3 (Very Unhealthy): 1,200 total (17.9%) | Kenya 5 | Mozambique 0 | Gambia 1,155
- PM2.5 > 100 ug/m3 (Hazardous mean): 0 total | Kenya 0 | Mozambique 0 | Gambia 0

**PM2.5 PEAK EXPOSURES (95th percentile > 100 ug/m3):**
- Participants with p95 PM2.5 > 100: 1,275 total (19.1%) | Kenya 0 | Mozambique 0 | Gambia 1,275
- This means 99.8% of Gambian participants experienced days with PM2.5 exceeding 100 ug/m3 (hazardous level)

**SETTLEMENT TYPE:**
- Kenya: 2,102 Urban (66%) | 256 Rural (8%) | 836 Peri-Urban (26%)
- Mozambique: 1,484 Urban (72%) | 421 Rural (21%) | 148 Peri-Urban (7%)
- Gambia: 505 Urban (40%) | 771 Rural (60%) | 2 Peri-Urban (0.2%)

**KEY INSIGHTS:**
- The Gambia has critical PM2.5 levels: ALL 1,278 participants (100%) exceed WHO guidelines, 90% exceed "Very Unhealthy" threshold
- CRITICAL: 1,275 Gambian participants (99.8%) have 95th percentile PM2.5 > 100 ug/m3 (hazardous level)
- Kenya has highest wet bulb temperatures: 2,189 participants (69%) exceed 20C wet bulb
- Mozambique has the mildest climate with lowest temperature and PM2.5 exposures
- When asked about PM2.5 > 100: No participants have MEAN PM2.5 > 100, but 1,275 Gambian participants experienced PEAK days > 100

=== METHODOLOGY ===
All environmental exposures use population-weighted methodology based on H3 hexagonal tessellation:
Formula: Indicator_PW = (Population_i  Value_i) / (Population_i)
This accounts for heterogeneous population distribution within village boundaries.

=== INSTRUCTIONS ===

**YOU HAVE LIVE DATA QUERY CAPABILITIES!**
You have access to tools that let you query the actual participant database (6,687 participants). Use these tools proactively:

1. **query_participants**: Find participants matching specific criteria (thresholds, combinations)
   - Use this when users ask "how many participants have X above Y"
   - Supports multiple filters combined (AND logic)
   - Returns breakdown by country and settlement type

2. **get_statistics**: Get mean, median, percentiles for any variable
   - Group by country or settlement type
   - Use for questions like "what's the average PM2.5 in Kenya?"

3. **compare_groups**: Compare a variable across countries or settlement types
   - Use for questions like "compare temperature between urban and rural"

4. **get_percentile_threshold**: Find percentile cutoffs and participants above/below
   - Use for "top 10% of PM2.5 exposure" or "75th percentile of temperature"

5. **cross_tabulation**: Create cross-tables
   - Use for "PM2.5 by country and settlement type"

**WHEN TO USE TOOLS:**
- For ANY specific numeric query, USE THE TOOLS to get live, accurate data
- The pre-computed statistics in this prompt are for reference - tools give you flexibility
- For complex queries not in your reference data, ALWAYS use tools
- When users ask about custom thresholds (e.g., "PM2.5 > 32"), use query_participants

**RESPONSE STYLE:**
- Be concise but include specific numbers from tool results
- Format numbers clearly (counts, percentages, statistics)
- Compare across countries when relevant
- Highlight notable findings (e.g., Gambia's high PM2.5)

**AVAILABLE VARIABLES FOR QUERIES:**
Air Quality: pm25, pm25_p95, pm25_max, pm25_d15 (WHO guideline), pm25_d25, pm25_d35, pm25_d50, pm25_d100, pm25_fire (fire smoke), pm25_nonfire, no2, o3, co, so2, aod, aod_dust, aod_bc (black carbon)
Temperature: temp, temp_max, temp_min, temp_p95, temp_diurnal, temp_d28, temp_d30, temp_d32, temp_d35
Heat Stress: wetbulb, wetbulb_max, wb_d20, wb_d25, wb_d28, lst, extreme_hot_days, heatwave_days, temp_deviation
Weather: humidity, hum_d80, hum_d90, precip, rain_d1, rain_d5, rain_d10
Environment: ndvi, elevation
Access: walk_dist, walk_time, drive_dist, drive_time, pt_dist, pt_time, dist_hwy, dist_road, road_dens, road_qual
Isolation: walk_iso_rd, walk_iso_hwy, drive_iso_rd, drive_iso_hwy, isolation
Socioeconomic: rwi, viirs, ppi (poverty probability)
Soil Nutrients: soil_ca, soil_n, soil_p, soil_k
Demographics: age, n (exposure days)`,

            init() {
                this.render();
                this.attachEvents();
            },

            render() {
                const widget = document.createElement('div');
                widget.className = 'chat-widget';
                widget.id = 'chat-widget';
                widget.innerHTML = `
                    <button class="chat-toggle" aria-label="Open chat">
                        <svg class="chat-icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/><path d="M7 9h10v2H7zm0-3h10v2H7z"/></svg>
                        <svg class="close-icon" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </button>
                    <div class="chat-panel">
                        <div class="chat-header">
                            <div class="chat-header-icon">&#129302;</div>
                            <div class="chat-header-text">
                                <h3>Shmron</h3>
                                <p>Ask about environmental maternal health indicators</p>
                            </div>
                        </div>
                        <div class="suggested-questions">
                            <button class="suggested-q" data-q="How many participants have PM2.5 above 35 ug/m3?">PM2.5 > 35?</button>
                            <button class="suggested-q" data-q="Compare temperature between urban and rural participants">Urban vs Rural temp</button>
                            <button class="suggested-q" data-q="Show me the top 10% of heat-exposed participants">Top 10% heat</button>
                            <button class="suggested-q" data-q="What's the average walking time to health facilities by country?">Walk time by country</button>
                        </div>
                        <div class="chat-messages" id="chat-messages"></div>
                        <div class="chat-input-area">
                            <div class="chat-input-wrapper">
                                <textarea class="chat-input" id="chat-input" placeholder="Ask about the indicators..." rows="1"></textarea>
                                <button class="chat-send" id="chat-send" aria-label="Send message">
                                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(widget);
                this.addMessage('system', "Hello! I'm Shmron, your AI research assistant for the PRECISE Network catalogue. I can now **query the live participant data** (N=6,687) to answer your questions!\n\nTry asking me:\n- Custom thresholds: *\"How many have PM2.5 > 40?\"*\n- Comparisons: *\"Compare humidity between countries\"*\n- Percentiles: *\"Who's in the top 25% of temperature exposure?\"*\n- Combined queries: *\"Rural participants in Kenya with high PM2.5\"*");
            },

            attachEvents() {
                document.querySelector('.chat-toggle').addEventListener('click', () => {
                    const widget = document.getElementById('chat-widget');
                    widget.classList.toggle('open');

                    // Load participant data when chat is first opened (for AI queries)
                    if (widget.classList.contains('open') && !participantData && !this.dataLoading) {
                        this.dataLoading = true;
                        this.loadDataForAI();
                    }
                });

                const input = document.getElementById('chat-input');
                const sendBtn = document.getElementById('chat-send');

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                input.addEventListener('input', () => {
                    input.style.height = 'auto';
                    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
                });

                sendBtn.addEventListener('click', () => this.sendMessage());

                document.querySelectorAll('.suggested-q').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const q = btn.getAttribute('data-q');
                        document.getElementById('chat-input').value = q;
                        this.sendMessage();
                    });
                });
            },

            async loadDataForAI() {
                try {
                    const url = 'https://raw.githubusercontent.com/Shmron/PRECISE/main/participant_data_expanded.json?v=' + Date.now();
                    const response = await fetch(url);
                    const json = await response.json();
                    participantData = json.data;
                    console.log('AI: Loaded', participantData.length, 'participants for queries');
                    this.dataLoading = false;
                } catch (error) {
                    console.error('Failed to load participant data for AI:', error);
                    this.dataLoading = false;
                }
            },

            addMessage(role, content) {
                const messagesEl = document.getElementById('chat-messages');
                const msgEl = document.createElement('div');
                msgEl.className = `chat-message ${role}`;
                msgEl.innerHTML = this.formatMessage(content);
                messagesEl.appendChild(msgEl);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            },

            formatMessage(content) {
                // Basic markdown-like formatting
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code style="background:#f0f0f0;padding:2px 6px;border-radius:3px;font-family:JetBrains Mono,monospace;font-size:0.85em">$1</code>')
                    .replace(/\n/g, '<br>');
            },

            showTyping() {
                const messagesEl = document.getElementById('chat-messages');
                const typingEl = document.createElement('div');
                typingEl.className = 'typing-indicator';
                typingEl.id = 'typing-indicator';
                typingEl.innerHTML = '<span></span><span></span><span></span>';
                messagesEl.appendChild(typingEl);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            },

            hideTyping() {
                const typingEl = document.getElementById('typing-indicator');
                if (typingEl) typingEl.remove();
            },

            async sendMessage() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();

                if (!message) return;

                input.value = '';
                input.style.height = 'auto';
                document.getElementById('chat-send').disabled = true;

                this.addMessage('user', message);
                this.conversationHistory.push({ role: 'user', content: message });

                this.showTyping();

                // Ensure data is loaded for tool queries
                if (!participantData && !this.dataLoading) {
                    this.updateTypingText('Loading participant data...');
                    await this.loadDataForAI();
                }

                try {
                    await this.processWithTools();
                } catch (error) {
                    this.hideTyping();
                    this.addMessage('system', `Error: ${error.message}. Please check your API key.`);
                    console.error('Chat error:', error);
                }

                document.getElementById('chat-send').disabled = false;
            },

            async processWithTools() {
                const maxIterations = 5; // Safety limit for tool use loops
                let iteration = 0;

                while (iteration < maxIterations) {
                    iteration++;

                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': this.apiKey,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 2048,
                            system: this.systemPrompt,
                            messages: this.conversationHistory,
                            tools: this.tools
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'API request failed');
                    }

                    const data = await response.json();

                    // Check if model wants to use tools
                    const toolUseBlocks = data.content.filter(c => c.type === 'tool_use');
                    const textBlocks = data.content.filter(c => c.type === 'text');

                    // If there's text, show it (might be thinking or partial response)
                    if (textBlocks.length > 0 && textBlocks[0].text.trim()) {
                        // Only show if it's not just a tool announcement
                        const text = textBlocks[0].text;
                        if (toolUseBlocks.length === 0 || text.length > 100) {
                            this.hideTyping();
                            this.addMessage('assistant', text);
                        }
                    }

                    // If there are tool calls, execute them
                    if (toolUseBlocks.length > 0) {
                        console.log('Tool calls:', toolUseBlocks.map(t => t.name));

                        // Show a subtle indicator that data is being queried
                        this.updateTypingText('Querying participant data...');

                        // Add assistant message with tool use to history
                        this.conversationHistory.push({ role: 'assistant', content: data.content });

                        // Execute tools and get results
                        const toolResults = this.executeTools(toolUseBlocks);

                        // Add tool results to history
                        this.conversationHistory.push({ role: 'user', content: toolResults });

                        // Continue loop to get final response
                        continue;
                    }

                    // No tool use - this is the final response
                    if (textBlocks.length > 0) {
                        this.hideTyping();
                        if (!textBlocks[0].text.trim()) {
                            this.addMessage('assistant', "I've processed your query. Is there anything specific you'd like to know?");
                        } else if (toolUseBlocks.length === 0) {
                            // Only add if we haven't already shown it above
                        } else {
                            this.addMessage('assistant', textBlocks[0].text);
                        }
                        this.conversationHistory.push({ role: 'assistant', content: data.content });
                    }

                    break;
                }
            },

            updateTypingText(text) {
                const typingEl = document.getElementById('typing-indicator');
                if (typingEl) {
                    typingEl.innerHTML = `<span class="typing-text" style="font-size: 0.8rem; color: var(--slate);">${text}</span>`;
                }
            }
        };

        // Initialize chatbot when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            try {
                ChatBot.init();
            } catch (e) {
                console.error('ChatBot initialization error:', e);
            }
        });
    </script>
</body>
</html>
